---
title: "Anàlisi descriptiva"
author: "Segon Salmerón Èric (1672984)"
date: "2026-01-11"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Llibreries
```{r}
library(data.table)
library(dplyr)
library(readr)
library(tidyr)
library(stringr)
library(tibble)
library(ggplot2)
library(lattice)
library(stringr)
library(psych)
library(lattice)
library(scales)
library(patchwork)
library(gplots)
library(FactoMineR)
library(factoextra)
library(sf)
library(here)
library(leaflet)
library(htmltools)
library(knitr)

dades<- readRDS("dades_finals.rds")
```

## DESCRIPCIÓ BASE DE DADES

#### Descripció NA
```{r, fig.pos='H'}
na_summary <- dades %>%
  summarise(across(
    everything(),
    ~ sum(is.na(.))
  )) %>%
  pivot_longer(
    cols = everything(),
    names_to = "variable",
    values_to = "n_NA"
  ) %>%
  mutate(
    percent_NA = round(n_NA / nrow(dades) * 100, 2)
  ) %>%
  filter(n_NA > 0) %>%
  arrange(desc(percent_NA))

kable(
  na_summary,
  col.names = c("Variable", "Nombre de NA", "% de NA"),
  caption = "Distribució de valors perduts (NA) per variable"
)

```


## PANORAMA ELECTORAL

### Evolució del total de vots de cada partit

#### Gràfic per partit
Els gràfics surten descentrats en compilar, arreglar-ho.
```{r, fig.align='center', fig.pos='H'}
vots_partit_eleccio <- dades %>%
  group_by(eleccio, sigles) %>%
  summarise(
    vots_totals = sum(vots, na.rm = TRUE),
    .groups = "drop"
  )

xyplot(
  vots_totals ~ eleccio | sigles,
  data = vots_partit_eleccio,
  type = "o",
  layout = c(3, 3),
  xlab = "Elecció",
  ylab = "Vots totals",
  main = "Evolució del vot per partit (2015–2023)",
  scales = list(x = list(rot = 45))
)
```
#### Evolució del vot per partit en un mateix gràfic 
```{r, fig.align='center', fig.pos='H'}
# Paleta de colors per partits
colors_partits <- c(
  "PSC/PSOE"    = "#E30613",
  "PP"          = "#1D4ED8",
  "ERC"         = "#FFB90F",
  "CONV./JxCAT" = "#76EEC6",
  "CUP/PR"      = "#FFD700",
  "CS"          = "#F97316",
  "VOX"         = "#00FF00",
  "ECP/SUMAR"   = "#7C3AED"
)


ggplot(vots_partit_eleccio,
       aes(x = eleccio, y = vots_totals, group = sigles, color = sigles)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_color_manual(values = colors_partits) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Evolució del vot total per partit",
    x = "Elecció",
    y = "Nombre total de vots",
    color = "Partit"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

### Evolució del vot per blocs de partits

#### Evolució del vot per blocs ideologics (esquerra-dreta)

```{r, fig.align='center', fig.pos='H'}
vots_ideologia <- dades %>%
  group_by(eleccio, ideologia) %>%
  summarise(vots_totals = sum(vots, na.rm = TRUE), .groups = "drop")


ggplot(vots_ideologia,
       aes(x = eleccio, y = vots_totals, fill = ideologia)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = c("Esquerra" = "#DC2626", "Dreta" = "#2563EB")) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Evolució del vot per blocs ideològics",
    x = "Elecció",
    y = "Nombre total de vots",
    fill = "Ideologia"
  ) +
  theme_minimal()

```


#### Evolució del vot per blocs independentistes i no independentistes

```{r, fig.align='center', fig.pos='H'}
vots_indep <- dades %>%
  group_by(eleccio, independentista) %>%
  summarise(vots_totals = sum(vots, na.rm = TRUE), .groups = "drop")

ggplot(vots_indep,
       aes(x = eleccio, y = vots_totals, fill = independentista)) +
  geom_col() +
  scale_fill_manual(values = c("Sí" = "#FF3030", "No" = "#00BFFF")) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Evolució del vot segons posicionament territorial",
    x = "Elecció",
    y = "Nombre total de vots",
    fill = "Independentista"
  ) +
  theme_minimal()

```


## Característiques de les seccions censals

### Distribucions de les variables socioeconòmiques clau

#### Estructura demogràfica
```{r, fig.height=4, fig.width=8, fig.pos='H'}
p_poblacio <- ggplot(dades, aes(x = Población)) +
  geom_histogram(bins = 30, fill = "#2563EB", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Població",
    x = "Nombre d'habitants",
    y = "Seccions"
  ) +
  theme_minimal()

p_edat <- ggplot(dades, aes(x = dades$`Edad media de la población`)) +
  geom_histogram(bins = 30, fill = "#1E40AF", alpha = 0.8) +
  labs(
    title = "Edat mitjana",
    x = "Anys",
    y = "Seccions"
  ) +
  theme_minimal()

p_poblacio | p_edat

```


#### Renda bruta 
```{r, fig.align='center', fig.pos='H'}
p_persona <- ggplot(dades, aes(x = `Renta bruta media por persona`)) +
  geom_histogram(bins = 30, fill = "#16A34A", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Renda bruta mitjana per persona",
    x = "€",
    y = "Nombre de seccions"
  ) +
  theme_minimal()

p_llar <- ggplot(dades, aes(x = `Renta bruta media por hogar`)) +
  geom_histogram(bins = 30, fill = "#0EA5E9", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Renda bruta mitjana per llar",
    x = "€",
    y = "Nombre de seccions"
  ) +
  theme_minimal()

p_persona + p_llar
```


#### Renda por unitat de consum

```{r, fig.align='center', fig.pos='H'}

p_mitjana <- ggplot(dades, aes(x = `Media de la renta por unidad de consumo`)) +
  geom_histogram(bins = 30, fill = "#7C3AED", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Renda mitjana per unitat de consum",
    x = "€",
    y = "Nombre de seccions"
  ) +
  theme_minimal()

p_mediana <- ggplot(dades, aes(x = `Mediana de la renta por unidad de consumo`)) +
  geom_histogram(bins = 30, fill = "#9333EA", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Mediana de la renda per unitat de consum",
    x = "€",
    y = "Nombre de seccions"
  ) +
  theme_minimal()

p_mitjana + p_mediana

```

#### Mesures de desigualtat

```{r, fig.align='center', fig.pos='H'}
# Panell de 2 gràfics amb la distribució de l'index gini i la del P80/P20. Estaria bé que l'histograma mostrés amb linies verticals de colors per exemple, quin son els nivells a partir dels quals considerem desigualtat (en l'index gini he fet servir aquest punts de tall breaks = "c(-Inf, 25, 35, Inf), abels = c( "Baixa desigualtat", "Desigualtat mitjana", "Alta desigualtat" 

p_mitjana <- ggplot(dades, aes(x = `Media de la renta por unidad de consumo`)) +
  geom_histogram(bins = 30, fill = "#7C3AED", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Renda mitjana per unitat de consum",
    x = "€",
    y = "Nombre de seccions"
  ) +
  theme_minimal()

p_mediana <- ggplot(dades, aes(x = `Mediana de la renta por unidad de consumo`)) +
  geom_histogram(bins = 30, fill = "#9333EA", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Mediana de la renda per unitat de consum",
    x = "€",
    y = "Nombre de seccions"
  ) +
  theme_minimal()

p_mitjana + p_mediana

```


## Vot i context socioecònomic

### Vot segons nivell socioeconòmic (variables categòriques)

```{r, fig.align='center', fig.pos='H'}
plot_vot_factor <- function(var, label_x, show_legend = TRUE) {
  p <- dades %>%
    filter(!is.na({{ var }})) %>%   
    group_by({{ var }}, sigles) %>%
    summarise(vots = sum(vots, na.rm = TRUE), .groups = "drop") %>%
    group_by({{ var }}) %>%
    mutate(percentatge = vots / sum(vots) * 100) %>%
    ggplot(aes(x = {{ var }}, y = percentatge, fill = sigles)) +
    geom_col() +
    scale_fill_manual(values = colors_partits) +
    scale_y_continuous(labels = percent_format(scale = 1)) +
    labs(
      x = label_x,
      y = "% de vots",
      fill = "Partit"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 30, hjust = 1))

  if (!show_legend) {
    p <- p + theme(legend.position = "none")
  }

  p
}

p_renda <- plot_vot_factor(
  fac_renda_bruta_persona,
  "Renda bruta per persona",
  show_legend = FALSE
)

p_gini <- plot_vot_factor(
  fac_indice_gini,
  "Desigualtat (Índex de Gini)",
  show_legend = FALSE
)

p_imm <- plot_vot_factor(
  fac_poblacio_no_espanyola,
  "Població no espanyola",
  show_legend = TRUE
)

p_edat <- plot_vot_factor(
  fac_Edad_media,
  "Edat mitjana",
  show_legend = TRUE
)
```


#### Renda bruta per persona i edat mitjana
```{r,fig.align='center', fig.pos='H'}
p_renda | p_edat
```


#### Gini I Immigració
```{r,fig.align='center', fig.pos='H'}
p_gini | p_imm
```

### Ideologia i vot independentista segons variables socioeconòmiques

Afegir per edat i dividir-ho en 4 panells (un per cada variable de l'eix X. Renda bruta per persona, desigualtat, immigració, edat)
```{r, fig.align='center', fig.pos='H'}
colors_indep <- c(
  "Sí" = "#B91C1C",   
  "No" = "#1D4ED8"    
)

plot_blocs_factor <- function(var, bloc, label_bloc, label_x) {
  dades %>%
    filter(!is.na({{ var }}), !is.na({{ bloc }})) %>% 
    group_by({{ var }}, {{ bloc }}) %>%
    summarise(vots = sum(vots, na.rm = TRUE), .groups = "drop") %>%
    group_by({{ var }}) %>%
    mutate(percentatge = vots / sum(vots) * 100) %>%
    ggplot(aes(x = {{ var }}, y = percentatge, fill = {{ bloc }})) +
    geom_col() +
    scale_y_continuous(labels = percent_format(scale = 1)) +
    labs(
      x = label_x,
      y = "% de vots",
      fill = label_bloc
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 30, hjust = 1)
      # Eliminar plot.margin si no és necessari
    )
}

# RENDA 
p_ideo_renda <- plot_blocs_factor(
  fac_renda_bruta_persona,
  ideologia,
  "Ideologia",
  "Renda bruta per persona"
)

p_indep_renda <- plot_blocs_factor(
  fac_renda_bruta_persona,
  independentista,
  "Independentisme",
  "Renda bruta per persona"
) +
  scale_fill_manual(values = colors_indep)

# Desigualtat
p_ideo_gini <- plot_blocs_factor(
  fac_indice_gini,
  ideologia,
  "Ideologia",
  "Desigualtat (Índex de Gini)"
)

p_indep_gini <- plot_blocs_factor(
  fac_indice_gini,
  independentista,
  "Independentisme",
  "Desigualtat (Índex de Gini)"
) +
  scale_fill_manual(values = colors_indep)

# IMMIGRACIÓ
p_ideo_imm <- plot_blocs_factor(
  fac_poblacio_no_espanyola,
  ideologia,
  "Ideologia",
  "Població no espanyola"
)

p_indep_imm <- plot_blocs_factor(
  fac_poblacio_no_espanyola,
  independentista,
  "Independentisme",
  "Població no espanyola"
) +
  scale_fill_manual(values = colors_indep)

p_ideo_edat <- plot_blocs_factor(
  fac_Edad_media,
  ideologia,
  "Ideologia",
  "Edat mitjana"
)

p_indep_edat <- plot_blocs_factor(
  fac_Edad_media,
  independentista,
  "Independentisme",
  "Edat mitjana"
) +
  scale_fill_manual(values = colors_indep)
```


#### Renda
```{r, fig.align='center', fig.pos='H'}
(p_ideo_renda | p_indep_renda) 
```

#### Gini
```{r, fig.align='center', fig.pos='H'}
(p_ideo_gini  | p_indep_gini) 
```


#### Immigració
```{r, fig.align='center', fig.pos='H'}
(p_ideo_imm   | p_indep_imm)  
```


#### Edat mitjana
```{r,fig.align='center', fig.pos='H'}
(p_ideo_edat  | p_indep_edat)
```

