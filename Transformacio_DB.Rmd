---
title: "Anàlisi descriptiva"
author: "Segon Salmerón Èric (1672984)"
date: "2026-01-09"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Transformació DB

Apartat on apliquem les transformacions necesàries per dur a terme l'anàlisi, partint d'un primer dataframe que conté les dades ajuntades però sense tractar

```{r}
dades_tr<- readRDS("dfcomplet.rds")
```


### Eliminació de variables 

Eliminem les seguents variables de la base de dades per ser poc informatives o per que no les usarem en les nostres anàlisis.


\begin{enumerate}
  \item \textbf{proces:} Tipus de procés electoral (En aquest cas només hi ha eleccions generals codificades amb 02).
  \item \textbf{volta:} Prèn el mateix valor que `mes`
  \item \textbf{ccaa:} Comunitat autònoma de la secció censal (En aquest cas sempre és Catalunya, codificada amb 09).
  \item \textbf{Districte:} Codi del districte, però és informació repetida (ja hi ha variable `districte`)
  \item \textbf{municipi:} Conté el codi del municipi, però es una variable redundant ja que tenim una altra `codi_municipi` amb la mateixa infomració
  \item \textbf{tipus:} Conté el tipus d'agrupació electoral (partit polític, coalició o altres formes jurídiques). No utilitzarem aquesta variable a la base de dades
  \item \textbd{candidatura:} Identificador numèric de cada candidatura electoral, pero obsercem que un mateix partit polític pot aparèixer associat a valors diferents de candidatura en funció de l’elecció, fet que impedeix utilitzar aquesta variable com a identificador estable de partit al llarg del temps. No la usarem, i tractarem la variable `sigles`per referir-nos als partits polítics
\end{enumerate}

```{r}
dades_tr <- subset(dades_tr, select = -c(proces, volta, ccaa, municipi, tipus, candidatura, Districte))
```


### Diccionari partits

La variable `sigles` conté el nom dels partits abreujat, pero com un mateix partit pot tenir diferents noms a la base de dades els intentem unificar amb un diccionari. També intentem unificar coalicions per simplificar l'anàlisi.

```{r}
diccionari_partits <- tribble(
  ~sigla_original,            ~sigla_std,
  "C's",                      "CS",
  "Cs",                       "CS",
  "ERC",                      "ERC",
  "ERC-CATSI",                "ERC",
  "ERC-CATSÍ",                "ERC",
  "ERC-SOBIRAN",              "ERC",
  "ERC-SOBIRANISTES",         "ERC",
  "JxCAT-JUNTS",              "CONV./JxCAT",
  "JxCAT - JUNTS",            "CONV./JxCAT",
  "CDC",                      "CONV./JxCAT",
  "CNV",                      "CONV./JxCAT",
  "DL",                       "CONV./JxCAT",
  "RECORTES CE",              "RECORTES CERO",
  "RECORTES CERO",            "RECORTES CERO",
  "RECORTES CERO-GRUPO VERDE","RECORTES CERO",
  "RECORTES CERO-GV",         "RECORTES CERO",
  "unio.cat",                 "UNIO",
  "Unio.Cat",                 "UNIO",
  "ECP",                      "ECP/SUMAR",
  "ECP-GUANYEM",              "ECP/SUMAR",
  "EN COMÚ",                  "ECP/SUMAR",
  "SUMAR - ECP",              "ECP/SUMAR",
  "MAS PAÍS",                 "EPC/SUMAR",
  "PSC",                      "PSC/PSOE",
  "PSC-PSOE",                 "PSC/PSOE",
  "CUP-PR",                   "CUP/PR"
)

# Aplicació del diccionari
dades_tr <- dades_tr %>%
  left_join(
    diccionari_partits,
    by = c("sigles" = "sigla_original")
  ) %>%
  mutate(
    sigles_final = coalesce(sigla_std, sigles)
  )

# Eliminació variables intermèdies per aconseguir les sigles finals
dades_tr <- subset(dades_tr, select = -c(sigles, sigla_std))

dades_tr <- dades_tr %>%
  rename(sigles = sigles_final)
```


### Variable ´eleccio`

Com l'any 2019 hi van haver dues eleccions generals (a l'abril i al novembre), per referir-nos a cada elecció concreta hem d'usar una combinació de les variables `any`i `mes`.

```{r}
dades_tr$eleccio <- paste0(
  dades_tr$any, "_",
  ifelse(dades_tr$mes == "04",  "abr",
  ifelse(dades_tr$mes == "06",  "jun",
  ifelse(dades_tr$mes == "07",  "jul",
  ifelse(dades_tr$mes == "11", "nov",
  ifelse(dades_tr$mes == "12", "des", NA)))))
)

#Definim factor ordenat
nivells_eleccio <- unique(dades_tr$eleccio[order(dades_tr$any, dades_tr$mes)])

dades_tr$eleccio <- factor(dades_tr$eleccio, levels = nivells_eleccio, ordered = TRUE)

```

### Consideració dels 8 partits més importants
Per tal de centrar l’anàlisi en les forces polítiques amb rellevància real al sistema de partits català, es restringeix la base de dades als 8 partits amb major nombre de vots totals acumulats en el conjunt de les cinc eleccions generals analitzades (2015, 2016, 2019_abr, 2019_nov i 2023).

Aquest criteri permet reduir la fragmentació causada per candidatures minoritàries i garanteix la comparabilitat longitudinal entre eleccions. 


#### Verificació dels 8 més rellevants
```{r}
#Vots totals per partit (tota la base de dades)
vots_per_partit <- dades_tr %>%
  group_by(sigles) %>%
  summarise(
    vots_totals = sum(vots, na.rm = TRUE),
    .groups = "drop"
  )

top8_partits <- vots_per_partit %>%
  arrange(desc(vots_totals)) %>%
  slice_head(n = 8)

# Càlcul del percentatge de vots que representa el top 10
percentatge_top8 <- sum(top8_partits$vots_totals)/
  sum(vots_per_partit$vots_totals)*100

# Top 8 vs resta
resum_top8 <- tibble(
  grup = c("Top 8 partits", "Resta de partits"),
  vots = c(
    sum(top8_partits$vots_totals),
    sum(vots_per_partit$vots_totals) - sum(top8_partits$vots_totals)
  )
) %>%
  mutate(
    percentatge = vots/sum(vots)*100
  )

# Gràfic de barres
ggplot(resum_top8, aes(x = grup, y = vots, fill = grup)) +
  geom_col() +
  geom_text(
    aes(label = paste0(round(percentatge, 1), "%")),
    vjust = -0.5
  ) +
  labs(
    title = "Pes electoral del Top 8 de partits",
    x = "",
    y = "Nombre total de vots"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```
Veiem també com només considerant els 8 primers ja tenim en compte una proporció molt elevada dels vots totals de la base de dades. 

#### Filtratge de dades
```{r}
dades_tr <- dades_tr %>%
  filter(sigles %in% top8_partits$sigles)
```

### Variables de ideologia política (classificació de partits)

Introduïm dues variables categòriques que permeten agrupar els partits polítics segons criteris ideològics en el sistema de partits català. En primer lloc l'eix ideològic esquerra–dreta (només 2 nivells per fer-lo més interpretable), que captura diferències programàtiques en termes econòmics i socials i posteriorment l'eix territorial, que distingeix entre forces independentistes i no independentistes.

La classificació es basa en l'autodefinició ideològica dels partits. Hem mantingut 2 categories per augmentar la interpretabilitat, i per que com treballem només amb 10 partits no considerem òptim afegir molts nivells. Som conscients que això suposa una pèrdua de precisió (per exemple, JxCat seria un Centre-Dreta, PSOE Centre-Esquerra, etc).

```{r}
# Esquerra, centre o dreta
diccionari_ideologia <- tribble(
~sigles,         ~ideologia,
"ERC",           "Esquerra",
"ECP/SUMAR",     "Esquerra",
"CUP/PR",        "Esquerra",
"PSC/PSOE",      "Esquerra",

"CS",            "Dreta",
"CONV.-JxCAT",   "Dreta",
"PP",            "Dreta",
"VOX",           "Dreta"
)


dades_tr <- dades_tr %>%
left_join(diccionari_ideologia, by = "sigles")

## El definim com a factor ordenat
dades_tr$ideologia <- factor(dades_tr$ideologia,levels = c("Esquerra", "Dreta"))



# Independentista si/no
diccionari_independentisme <- tribble(
~sigles,         ~independentista,
"ERC",           "Sí",
"CONV./JxCAT",   "Sí",
"CUP/PR",        "Sí",

"PSC/PSOE",      "No",
"PP",            "No",
"CS",            "No",
"VOX",           "No",
"ECP/SUMAR",     "No",
"PACMA",         "No"
)

dades_tr <- dades_tr %>%
left_join(diccionari_independentisme, by = "sigles")

dades_tr$independentista<- as.factor(dades_tr$independentista)
```


### Correcció del tipus de variable

Correcció de variables que no són del tipus esperat

```{r}
dades_tr <- dades_tr %>%
  mutate(
    
    #Numèriques
    any = as.numeric(any), #Variable temporal
    mes = as.numeric(mes), #Variable temporal
    
    #Factors
    provincia        = factor(provincia),
    districte        = factor(districte),
    seccio           = factor(seccio),
    sigles           = factor(sigles),
    nom_partit       = factor(nom_partit),
    Municipi         = factor(Municipi),
    Codi_municipi    = factor(Codi_municipi)
  )

```


### Factorització de variables numèriques

De cara a la descripció de la base de dades i a la modelització és interessant tenir també una versió en factor de certes variables numèriques. Els punts de tall del factor vindran determinats per criteris socials o bé per tercils, quartils o quintils, en funció de quants grups sigui adient definir en cada cas.


(Nota, no sé si es del tot correcte ja que en alguns casos es posible que els grups no siguin molt diferents entre ells)

#### Edat

```{r}
summary(dades_tr[["Edad media de la población"]])

hist(
  dades_tr[["Edad media de la población"]],
  main = "Edat mitjana de la població",
  xlab = "Edat mitjana (anys)",
  breaks = 30
)
```


Punts de tall establerts amb criteri social interpretatiu:

$\text{Mitjana edat} < 40 = \text{Secció jove}$

$40 < \text{Mitjana edat} < 45 = \text{Secció d'edat mitjana}$

$\text{Mitjana edat} > 45 = \text{Secció jove}$

```{r}
dades_tr$fac_Edad_media <- cut(
  dades_tr$`Edad media de la población`,
  breaks = c(-Inf, 40, 45, Inf),
  labels = c("Secció jove", "Secció d'edat mitjana", "Secció envellida"),
  include.lowest = TRUE
)

plot(dades_tr$fac_Edad_media)
```

#### Població

```{r}
summary(dades_tr$Población)

hist(
dades_tr$Población,
main = "Població per secció censal",
xlab = "Nombre d'habitants",
breaks = 30
)

```

Punts de talls establerts amb quartils:


```{r}
cuts_pob <- quantile(
dades_tr$Población,
probs = c(0, 0.25, 0.5, 0.75, 1),
na.rm = TRUE
)

dades_tr$fac_Población <- cut(
dades_tr$Población,
breaks = cuts_pob,
include.lowest = TRUE,
labels = c(
"Població baixa",
"Població mitjana-baixa",
"Població mitjana-alta",
"Població alta"
)
)

cuts_pob


```

#### Mida mitjana de la llar
```{r}
summary(dades_tr$`Tamaño medio del hogar`)

hist(
dades_tr$`Tamaño medio del hogar`,
main = "Mida mitjana de la llar",
xlab = "Persones per llar",
breaks = 30
)

```

```{r}
cuts_hogar <- quantile(
dades_tr$`Tamaño medio del hogar`,
probs = c(0, 1/3, 2/3, 1),
na.rm = TRUE
)

dades_tr$fac_Tamaño_medio_del_hogar <- cut(
dades_tr$`Tamaño medio del hogar`,
breaks = cuts_hogar,
include.lowest = TRUE,
labels = c(
"Llars petites",
"Llars mitjanes",
"Llars grans"
)
)

cuts_hogar

```
#### Renda bruta mitjana per persona

```{r}
summary(dades_tr$`Renta bruta media por persona`)

hist(
dades_tr$`Renta bruta media por persona`,
main = "Renda bruta mitjana per persona",
xlab = "Renda (€)",
breaks = 30
)

```

Punts de tall establerts amb quartils

```{r}
cuts_renda_persona <- quantile(
dades_tr$`Renta bruta media por persona`,
probs = seq(0,1,by=0.2),
na.rm = TRUE
)

dades_tr$fac_renda_bruta_persona <- cut(
dades_tr$`Renta bruta media por persona`,
breaks = cuts_renda_persona,
include.lowest = TRUE,
labels = c(
"Renda molt baixa",
"Renda baixa",
"Renda mitjana",
"Renda alta",
"Renda molt alta"
)
)

cuts_renda_persona

```


#### Renda bruta mitjana per llar

```{r}
summary(dades_tr$`Renta bruta media por hogar`)

hist(
dades_tr$`Renta bruta media por hogar`,
main = "Renda bruta mitjana per llar",
xlab = "Renda (€)",
breaks = 30
)

```

Punts de talls establerts amb quartils

```{r}
cuts_renda_llar <- quantile(
dades_tr$`Renta bruta media por hogar`,
probs = seq(0,1,by=0.2),
na.rm = TRUE
)

dades_tr$fac_renda_bruta_llar <- cut(
dades_tr$`Renta bruta media por hogar`,
breaks = cuts_renda_llar,
include.lowest = TRUE,
labels = c(
"Renda molt baixa",
"Renda baixa",
"Renda mitjana",
"Renda alta",
"Renda molt alta"
)
)

cuts_renda_llar
```



#### Mitjana de la renda per unitat de consum
```{r}
summary(dades_tr$`Media de la renta por unidad de consumo`)

hist(
dades_tr$`Media de la renta por unidad de consumo`,
main = "Renda mitjana per unitat de consum",
xlab = "Renda (€)",
breaks = 30
)

```

Punts de talls triats amb quintils

```{r}
cuts_renda_uc <- quantile(
dades_tr$`Media de la renta por unidad de consumo`,
probs = seq(0, 1, 0.2),
na.rm = TRUE
)

dades_tr$fac_renda_media_uc <- cut(
dades_tr$`Media de la renta por unidad de consumo`,
breaks = cuts_renda_uc,
include.lowest = TRUE,
labels = c(
"Renda molt baixa",
"Renda baixa",
"Renda mitjana",
"Renda alta",
"Renda molt alta"
)
)

cuts_renda_uc
```


#### Mediana de la renda per unitat de consum

```{r}
summary(dades_tr$`Mediana de la renta por unidad de consumo`)

hist(
dades_tr$`Mediana de la renta por unidad de consumo`,
main = "Mediana de la renda per unitat de consum",
xlab = "Renda (€)",
breaks = 25
)

```

```{r}
cuts_mediana_uc <- quantile(
dades_tr$`Mediana de la renta por unidad de consumo`,
probs = seq(0, 1, 0.2),
na.rm = TRUE
)

dades_tr$fac_renda_mediana_uc <- cut(
dades_tr$`Mediana de la renta por unidad de consumo`,
breaks = cuts_mediana_uc,
include.lowest = TRUE,
labels = c(
"Renda molt baixa",
"Renda baixa",
"Renda mitjana",
"Renda alta",
"Renda molt alta"
)
)

cuts_mediana_uc
```

#### Distribució de índex de Gini

```{r}
summary(dades_tr$`Índice de Gini`)

hist(
dades_tr$`Índice de Gini`,
main = "Desigualtat en la distribució de la renda (Índex de Gini)",
xlab = "Índex de Gini",
breaks = 30
)


```


Punts de tall triats a partir de llindars habituals en estudis de desigualtat.

$\text{Gini} < 25\% = \text{Poca desigualtat}$

$20\% < \text{Mitjana edat} < 35\% = \text{Moderada desigualtat}$

$\text{Mitjana edat} > 35% = \text{Alta desigualta}$

```{r}
dades_tr$fac_indice_gini <- cut(
dades_tr$`Índice de Gini`,
breaks = c(-Inf, 25, 35, Inf),
include.lowest = TRUE,
labels = c(
"Baixa desigualtat",
"Desigualtat mitjana",
"Alta desigualtat"
)
)

plot(dades_tr$fac_indice_gini)
```


#### Població no espanyola

```{r}
dades_tr$Porcentaje_poblacion_no_española<- 100-dades_tr$`Porcentaje de población española`

summary(dades_tr$Porcentaje_poblacion_no_española)

hist(
dades_tr$Porcentaje_poblacion_no_española,
main = "Porcentaje de población no española",
xlab = "Población no española",
breaks = 25
)
```

Punts de tall triats amb tercils

```{r}
cuts_immigracio <- quantile(
  dades_tr$Porcentaje_poblacion_no_española,
  probs = c(0, 1/3, 2/3, 1),
  na.rm = TRUE
)

dades_tr$fac_poblacio_no_espanyola <- cut(
  dades_tr$Porcentaje_poblacion_no_española,
  breaks = cuts_immigracio,
  include.lowest = TRUE,
  labels = c(
    "Baixa immigració",
    "Mitjana immigració",
    "Alta immigració"
  )
)

cuts_immigracio
```

