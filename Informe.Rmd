---
output:
  pdf_document:
    latex_engine: pdflatex
bibliography: referencies.bib
csl: numeric.csl
fontsize: 11pt
geometry: margin=2.5cm
header-includes:
  - \usepackage[catalan]{babel}
  - \usepackage{float}
  - \usepackage{setspace}
  - \onehalfspacing
---

\begin{titlepage}
\centering

% Logo a la part superior
\vspace*{1cm}
\includegraphics[width=6cm]{logo_uab.png}

\vspace*{2cm}

% Títol
{\Huge \textbf{Anàlisi del comportament electoral a Catalunya: evolució i influència dels factors socioeconòmics i demogràfics}}\\[0.3cm]
\rule{12cm}{0.4pt}\\[0.3cm]
{\Large \textit{Estudi sobre les eleccions generals espanyoles mitjançant dades de les seccions censals al territori català}}\\[2.5cm]

% Autors
{\Large
Aniol Vilamala Vidal\\
Jordi Anguera Costa\\
Èric Segon Salmerón\\
Daniel Jiménez López
}\\[2cm]

\vfill

% Informació institucional
{\large Grau en Estadística Aplicada}\\
{\large Universitat Autònoma de Barcelona}\\[1cm]

% Data al peu de pàgina
{\large Barcelona, 29 de gener de 2026}

\end{titlepage}

\pagenumbering{gobble}  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      fig.width = 6, fig.height = 3)
```

```{r}
library(data.table)
library(dplyr)
library(readr)
library(tidyr)
library(stringr)
library(tibble)
library(ggplot2)
library(lattice)
library(stringr)
library(psych)
library(lattice)
library(scales)
library(patchwork)
library(gplots)
library(car)
library(MASS)
library(lme4)
library(lmerTest)
library(kableExtra)
library(gtsummary)
library(FactoMineR)
library(factoextra)
library(sf)
library(here)
library(leaflet)
library(htmltools)
library(randomForest)
library(xgboost)
library(rsample)
library(fastshap)
library(vip)
library(caret)
```

\newpage
\thispagestyle{empty}
\mbox{}
\newpage

\pagenumbering{Roman}

# Resum

El projecte es basa en l’anàlisi de dades censals agregades amb l’objectiu de desenvolupar diferents models estadístics de caràcter explicatiu que permetin analitzar i comprendre els resultats electorals observats en les diverses unitats censals al llarg de diferents processos electorals i anys. Per dur a terme aquest anàlisi, s’incorporaran variables socioeconòmiques, amb especial atenció als indicadors relacionats amb la renda i altres factors que influeixen en les condicions de vida de la població. Aquestes variables s’utilitzaran com a factors explicatius del comportament electoral mitjançant l’aplicació de models lineals (LM) i models lineals mixtos (LMER), que permetran capturar tant els efectes fixos de les variables socioeconòmiques com la variabilitat associada a diferents nivells territorials o temporals. De manera complementària, s’empraran tècniques com l’Anàlisi de Correspondències (CA), orientada a identificar patrons i relacions entre categories, i models de Random Forest, que permetran capturar relacions no lineals i avaluar la importància relativa de les diferents variables. Aquest enfocament possibilitarà analitzar la relació entre les característiques socioeconòmiques i l’evolució dels resultats electorals en el temps i entre territoris. L’enfocament de l’estudi serà principalment explicatiu, orientat a identificar patrons i associacions rellevants entre les característiques socioeconòmiques dels censos i els resultats electorals, així com a realitzar comparacions entre diferents períodes temporals sempre que la disponibilitat de dades ho permeti.

# Abstract

The project is based on the analysis of aggregated census data with the aim of developing different explanatory statistical models to analyze and understand the electoral results observed across various census units over different electoral processes and years. To carry out this analysis, socioeconomic variables will be incorporated, with special attention to indicators related to income and other factors influencing the population’s living conditions. These variables will be used as explanatory factors of electoral behavior through the application of linear models (LM) and linear mixed-effects models (LMER), which will allow capturing both the fixed effects of socioeconomic variables and the variability associated with different territorial or temporal levels. In addition, techniques such as Correspondence Analysis (CA) will be employed to identify patterns and relationships between categorical variables, while Random Forest models will be used to capture non-linear relationships and assess the relative importance of the explanatory variables. This combined approach will make it possible to analyze the relationship between socioeconomic characteristics and the evolution of electoral outcomes over time and across territories. The study will adopt a primarily explanatory perspective, aimed at identifying relevant patterns and associations between the socioeconomic characteristics of census units and electoral results, as well as enabling comparisons across different time periods whenever data availability allows.


\newpage
\tableofcontents
\newpage

\pagenumbering{arabic}


# 1. Introducció

El comportament electoral constitueix una de les expressions més visibles de la dinàmica política d’una societat i, alhora, un fenomen profundament arrelat en les seves estructures socials, econòmiques i territorials. L’anàlisi del vot permet no només descriure preferències polítiques, sinó també entendre com les desigualtats socials, les trajectòries històriques i les característiques demogràfiques es tradueixen en patrons polítics diferenciats. En aquest sentit, el territori català ofereix un context especialment rellevant per a l’estudi del comportament electoral, atesa la seva singularitat dins del sistema polític espanyol.

Les eleccions generals espanyoles han estat, en les darreres dècades, un espai de competència política marcat tant per eixos ideològics clàssics com per dinàmiques pròpies del context català. La coexistència de partits d’àmbit estatal i formacions amb una forta implantació territorial, així com la importància creixent del debat territorial, han contribuït a configurar un mapa electoral complex i canviant. Aquestes característiques fan necessari un enfocament analític que combini la dimensió territorial amb l’estudi dels factors socioeconòmics i demogràfics que influeixen en la distribució del vot.

Tradicionalment, una part important dels estudis electorals s’ha centrat en unitats d’anàlisi relativament agregades, com ara municipis o circumscripcions. Tot i la utilitat d’aquests enfocaments, l’ús de dades a una escala més fina, com la secció censal, permet captar amb major precisió les desigualtats internes del territori i identificar patrons que poden quedar ocults en nivells d’agregació superiors. Aquesta aproximació facilita una lectura més detallada del comportament electoral i obre la porta a una anàlisi més acurada de la relació entre context social i vot.

En aquest treball s’analitza el comportament electoral a Catalunya en diverses convocatòries de les eleccions generals espanyoles, amb l’objectiu de comprendre com es distribueix el suport als diferents partits i blocs ideològics, com evoluciona al llarg del temps i quins factors contribueixen de manera més rellevant a explicar aquestes dinàmiques. L’estudi combina informació electoral detallada amb un conjunt ampli de variables socioeconòmiques i demogràfiques.


\newpage
# 2. Objectius

## 2.1 Objectiu general

L'objectiu principal del present treball és comprendre com es configura el comportament electoral de les eleccions generals espanyoles al territori català, explorant de quina manera les característiques socials, econòmiques i demogràfiques contribueixen a explicar la distribució del vot i la seva evolució al llarg del temps.

## 2.2. Objectius específics

Per assolir l'objectiu principal s'han establert els següents objectius específics:

- **Patró territorial del vot**  
  Analitzar com es distribueix el suport als diferents partits polítics en el territori català, identificant les diferències entre espais i les regularitats que s’hi repeteixen.

- **Comportament electoral per blocs ideològics**  
  Examinar com varien les preferències electorals quan s’agrupen els partits en grans blocs ideològics, i fins a quin punt les condicions socials i econòmiques influeixen en aquestes diferències.

- **Dinàmica temporal del vot**  
  Descriure com evoluciona el comportament electoral entre diferents convocatòries, posant atenció als canvis, continuïtats i possibles reconfiguracions del mapa polític català.

- **Factors determinants del vot**  
  Identificar quins elements socioeconòmics i demogràfics tenen un pes més rellevant en la configuració del vot i com interactuen amb les particularitats territorials.


\newpage
# 3. Dades

D’una banda, les dades referents als vots als partits sobre cada secció censals estan disponibles a l'àrea de descarregues de les eleccions de la pàgina del Ministeri de l’Interior [@ministerioInterior_descargas]. Cada resultat electoral conté un fitxer ZIP amb 10 fitxers d'extensió .DAT, així com 1 fitxer .doc i 1 .rtf. Aquests dos últims expliquen la codificació de cada fitxer i en descriuen el contingut. Els que comencen per “10” contenen la informació de vots per partit a cada secció censal, mentre que els que comencen per “03” inclouen un diccionari amb les sigles de cada partit i el seu nom complet.

A partir del fitxer comprimit del Ministeri de l’Interior, vam transformar les dades electorals administratives en una base de dades apta per a l’anàlisi a escala de secció censal. Els fitxers del tipus “10” contenien els vots per candidatura en format de longitud fixa, fet que va requerir consultar la documentació tècnica per interpretar correctament cada camp. Un cop entès el format, vam desenvolupar un script en R per llegir i estructurar aquestes dades.

Paral·lelament, els fitxers “03” proporcionaven el diccionari de candidatures, també en format de longitud fixa, i van ser essencials per identificar la sigla i el nom complet de cada partit. Com que els codis de candidatura variaven entre eleccions, va ser necessari enllaçar, per a cada procés electoral, els fitxers “10” amb el seu corresponent “03”. Només després d’aquest pas vam poder integrar totes les eleccions en una mateixa base de dades.

\vspace{0.75cm}

D'altra banda, pel que fa a les variables socioeconòmiques i demogràfiques, les vam obtenir de l’INE, concretament de l’apartat dedicat a les condicions de vida per secció censal [@INE_condiciones_vida]. Per a cada província catalana vam descarregar quatre bases de dades complementàries, cadascuna amb un conjunt específic d’indicadors: una amb l’índex de Gini i la ràtio 80/20 de distribució de la renda; una altra amb la procedència dels ingressos; una tercera amb variables demogràfiques com l’edat mitjana o el percentatge de població espanyola resident; i una darrera amb dades de renda mitjana per unitat de consum, personal i de la llar.

En el cas de les comarques gironines, el tractament va requerir una atenció addicional, ja que la codificació de les seccions censals no seguia exactament el mateix format que a la resta del territori.

Un cop harmonitzades, totes les bases de dades es van integrar en un únic conjunt, agrupant-les per any i secció censal.


\newpage
# 4. Materials i mètodes

L’anàlisi s’ha realitzat amb el programari `R (versió 4.5)`, que ha permès gestionar, transformar i modelitzar les dades de manera eficient. Per al tractament i la manipulació de dades s’han utilitzat paquets del conjunt `tidyverse` [@tidyverse] i altres llibreries especialitzades, com `data.table` [@data.table], `dplyr` [@dplyr], `readr` [@readr], `tidyr` [@tidyr], `stringr` [@stringr], `tibble` [@tibble] i `scales` [@scales], que han facilitat la neteja, reorganització i harmonització de les diferents fonts d’informació.

La visualització de dades s’ha dut a terme principalment amb `ggplot2` [@ggplot2], complementat amb `lattice` [@lattice], `gplots` [@gplots], `patchwork` [@patchwork] i eines de presentació enriquida com `kableExtra` [@kableExtra] i `gtsummary` [@gtsummary]. Per a la creació de mapes i la gestió d’informació geoespacial s’ha utilitzat el paquet `sf` [@sf], juntament amb `leaflet` [@leaflet] i `htmltools` [@htmltools] per generar visualitzacions interactives. El paquet `here` [@here] ha permès estructurar de manera robusta els camins i l’organització interna del projecte.

Pel que fa a l’anàlisi estadística, s’han aplicat models lineals (`car` [@car], `MASS` [@MASS]) i models lineals mixtos (`lme4` [@lme4], `lmerTest` [@lmerTest]), així com tècniques d’aprenentatge automàtic com els `random forest` [@rf] i els models `xgboost` [@xgboost], amb el suport dels paquets `caret` [@caret], `fastshap` [@fastshap], `rsample` [@rsample] i `vip` [@vip]. L’anàlisi multivariant, i en particular l’anàlisi de correspondències, s’ha realitzat amb `FactoMineR` [@FactoMineR] i `factoextra` [@factoextra], que han facilitat tant el càlcul com la interpretació gràfica dels resultats. Addicionalment, el paquet `psych` [@psych] ha estat útil per a estadístiques descriptives i exploratòries.


\newpage
# 5. Resultats

## 5.1 Anàlisi Exploratòria de Dades (AED)

Aquest apartat serveix com a pas prèvi a la modelització, per descriure la base de dades final i situar-la en el context polític i socioeconòmic estudiat. 

### 5.1.1 Descripció valors perduts

```{r, fig.pos = 'htbp', fig.cap='Distribució valors perduts'}
dades<- readRDS("dades_finals.rds")

na_summary <- dades %>%
  summarise(across(
    everything(),
    ~ sum(is.na(.))
  )) %>%
  pivot_longer(
    cols = everything(),
    names_to = "variable",
    values_to = "n_NA"
  ) %>%
  mutate(
    percent_NA = round(n_NA / nrow(dades) * 100, 2)
  ) %>%
  filter(n_NA > 0) %>%
  arrange(desc(percent_NA))

kable(
  na_summary,
  col.names = c("Variable", "Nombre de NA", "% de NA"),
  caption = "Distribució de valors perduts (NA) per variable"
)

```

La taula presenta les variables en ordre decreixent segons la freqüència de valors perduts de valors perduts *NA*. Totes les variables tenen entre un $0 \%$ i un $1 \%$ de valors perduts. 

\newpage

### 5.1.2 Panorama electoral

#### Evolució del vot per partit en un mateix gràfic 


```{r, fig.align='center', fig.pos = 'htbp', fig.cap='Evolució vot per partit'}
vots_partit_eleccio <- dades %>%
  group_by(eleccio, sigles) %>%
  summarise(
    vots_totals = sum(vots, na.rm = TRUE),
    .groups = "drop"
  )

# Paleta de colors per partits
colors_partits <- c(
  "PSC/PSOE"    = "#E30613",
  "PP"          = "#1D4ED8",
  "ERC"         = "#FFB90F",
  "CONV./JxCAT" = "#76EEC6",
  "CUP/PR"      = "#FFD700",
  "CS"          = "#F97316",
  "VOX"         = "#00FF00",
  "ECP/SUMAR"   = "#7C3AED"
)


ggplot(vots_partit_eleccio,
       aes(x = eleccio, y = vots_totals, group = sigles, color = sigles)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_color_manual(values = colors_partits) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Evolució del vot total per partit",
    x = "Elecció",
    y = "Nombre total de vots",
    color = "Partit"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```
Aquest gràfic presenta l'evolució dels partits al llarg de les eleccions. S'observa per exemple tendències alcistes del PSC i de VOX. 


\newpage

### 5.1.3 Evolució del vot per blocs de partits


#### Evolució del vot per blocs ideologics (esquerra-dreta)


```{r, fig.align='center', fig.pos = 'htbp', fig.cap='Evolució bot segons vots ideològics'}
vots_ideologia <- dades %>%
  group_by(eleccio, ideologia) %>%
  summarise(vots_totals = sum(vots, na.rm = TRUE), .groups = "drop")


ggplot(vots_ideologia,
       aes(x = eleccio, y = vots_totals, fill = ideologia)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = c("Esquerra" = "#DC2626", "Dreta" = "#2563EB")) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Evolució del vot per blocs ideològics",
    x = "Elecció",
    y = "Nombre total de vots",
    fill = "Ideologia"
  ) +
  theme_minimal()

```
A Catalunya, independentment de l'elecció, hi predomina el vot a partits catalogats com d'esquerres. 


#### Evolució del vot per blocs independentistes i no independentistes


```{r, fig.align='center', fig.pos = 'htbp', fig.cap='Evolució vot segons independentisme'}
vots_indep <- dades %>%
  group_by(eleccio, independentista) %>%
  summarise(vots_totals = sum(vots, na.rm = TRUE), .groups = "drop")

ggplot(vots_indep,
       aes(x = eleccio, y = vots_totals, fill = independentista)) +
  geom_col() +
  scale_fill_manual(values = c("Sí" = "#FF3030", "No" = "#00BFFF")) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Evolució vot segons independentisme",
    x = "Elecció",
    y = "Nombre total de vots",
    fill = "Independentista"
  ) +
  theme_minimal()

```
En aquesta figura podem veure l'evolució del vot a partits independentistes. Cal recordar que aquest estudi es fa a partir dels resultats de les eleccions generals del govern espanyol però només contemplant dades provinents de Catalunya. Comentem aquest fet, ja que els vots a catalunya de partits independentistes acostumen a ser mes baixos en aquestes eleccions que en les autonòmiques. 


\newpage

### 5.1.4 Característiques de les seccions censals

A continuació es mostra la distribució de diferents variables econòmiques i demogràfiques a nivell de secció censal. 


```{r, fig.height=4, fig.width=8, fig.pos = 'htbp', fig.cap='Estructura demogràfica'}
p_poblacio <- ggplot(dades, aes(x = Población)) +
  geom_histogram(bins = 30, fill = "#2563EB", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Població",
    x = "Nombre d'habitants",
    y = "Seccions"
  ) +
  theme_minimal()

p_edat <- ggplot(dades, aes(x = dades$`Edad media de la población`)) +
  geom_histogram(bins = 30, fill = "#1E40AF", alpha = 0.8) +
  labs(
    title = "Edat mitjana",
    x = "Edat",
    y = "Seccions"
  ) +
  theme_minimal()

p_poblacio | p_edat

```




```{r, fig.align='center', fig.pos = 'htbp', fig.cap='Renda bruta'}
p_persona <- ggplot(dades, aes(x = `Renta bruta media por persona`)) +
  geom_histogram(bins = 30, fill = "#16A34A", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Renda bruta mitjana per persona",
    x = "€",
    y = "Nombre de seccions"
  ) +
  theme_minimal()

p_llar <- ggplot(dades, aes(x = `Renta bruta media por hogar`)) +
  geom_histogram(bins = 30, fill = "#0EA5E9", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Renda bruta mitjana per llar",
    x = "€",
    y = "Nombre de seccions"
  ) +
  theme_minimal()

p_persona + p_llar
```




```{r, fig.align='center', fig.pos = 'htbp', fig.cap='Renda per unitat de consum'}

p_mitjana <- ggplot(dades, aes(x = `Media de la renta por unidad de consumo`)) +
  geom_histogram(bins = 30, fill = "#7C3AED", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Renda mitjana per unitat de consum",
    x = "€",
    y = "Nombre de seccions"
  ) +
  theme_minimal()

p_mediana <- ggplot(dades, aes(x = `Mediana de la renta por unidad de consumo`)) +
  geom_histogram(bins = 30, fill = "#9333EA", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Mediana de la renda per unitat de consum",
    x = "€",
    y = "Nombre de seccions"
  ) +
  theme_minimal()

p_mitjana + p_mediana
```



```{r, fig.align='center', fig.pos = 'htbp', fig.cap='Mesures desigualtat'}
p_mitjana <- ggplot(dades, aes(x = `Media de la renta por unidad de consumo`)) +
  geom_histogram(bins = 30, fill = "#7C3AED", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Renda mitjana per unitat de consum",
    x = "€",
    y = "Nombre de seccions"
  ) +
  theme_minimal()

p_mediana <- ggplot(dades, aes(x = `Mediana de la renta por unidad de consumo`)) +
  geom_histogram(bins = 30, fill = "#9333EA", alpha = 0.8) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Mediana de la renda per unitat de consum",
    x = "€",
    y = "Nombre de seccions"
  ) +
  theme_minimal()

p_mitjana + p_mediana

```


\newpage


### 5.1.5 Vot i context socioecònomic

A continuació es mostra de manera qualitativa la dsitribució total (és a dir, tenint en compte totes les eleccions) de vot segons diferents variables de les seccions.  




```{r, fig.align='center', fig.pos = 'htbp'}
plot_vot_factor <- function(var, label_x, show_legend = TRUE) {
  p <- dades %>%
    filter(!is.na({{ var }})) %>%   
    group_by({{ var }}, sigles) %>%
    summarise(vots = sum(vots, na.rm = TRUE), .groups = "drop") %>%
    group_by({{ var }}) %>%
    mutate(percentatge = vots / sum(vots) * 100) %>%
    ggplot(aes(x = {{ var }}, y = percentatge, fill = sigles)) +
    geom_col() +
    scale_fill_manual(values = colors_partits) +
    scale_y_continuous(labels = percent_format(scale = 1)) +
    labs(
      x = label_x,
      y = "% de vots",
      fill = "Partit"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 30, hjust = 1))

  if (!show_legend) {
    p <- p + theme(legend.position = "none")
  }

  p
}

p_renda <- plot_vot_factor(
  fac_renda_bruta_persona,
  "Renda bruta per persona",
  show_legend = FALSE
)

p_gini <- plot_vot_factor(
  fac_indice_gini,
  "Desigualtat (Índex de Gini)",
  show_legend = FALSE
)

p_imm <- plot_vot_factor(
  fac_poblacio_no_espanyola,
  "Població no espanyola",
  show_legend = TRUE
)

p_edat <- plot_vot_factor(
  fac_Edad_media,
  "Edat mitjana",
  show_legend = TRUE
)
```





```{r,fig.align='center', fig.pos = 'htbp', fig.cap='Renda bruta per persona i edat mitjana'}
p_renda | p_edat
```





```{r,fig.align='center', fig.pos = 'htbp', fig.cap='Gini i Immigració'}
p_gini | p_imm
```




```{r, fig.align='center', fig.pos = 'htbp', fig.cap='Ideologia i vot independentista segons variables socioeconòmiques'}
colors_indep <- c(
  "Sí" = "#B91C1C",   
  "No" = "#1D4ED8"    
)

plot_blocs_factor <- function(var, bloc, label_bloc, label_x) {
  dades %>%
    filter(!is.na({{ var }}), !is.na({{ bloc }})) %>% 
    group_by({{ var }}, {{ bloc }}) %>%
    summarise(vots = sum(vots, na.rm = TRUE), .groups = "drop") %>%
    group_by({{ var }}) %>%
    mutate(percentatge = vots / sum(vots) * 100) %>%
    ggplot(aes(x = {{ var }}, y = percentatge, fill = {{ bloc }})) +
    geom_col() +
    scale_y_continuous(labels = percent_format(scale = 1)) +
    labs(
      x = label_x,
      y = "% de vots",
      fill = label_bloc
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 30, hjust = 1)
      # Eliminar plot.margin si no és necessari
    )
}

# RENDA 
p_ideo_renda <- plot_blocs_factor(
  fac_renda_bruta_persona,
  ideologia,
  "Ideologia",
  "Renda bruta per persona"
)

p_indep_renda <- plot_blocs_factor(
  fac_renda_bruta_persona,
  independentista,
  "Independentisme",
  "Renda bruta per persona"
) +
  scale_fill_manual(values = colors_indep)

# Desigualtat
p_ideo_gini <- plot_blocs_factor(
  fac_indice_gini,
  ideologia,
  "Ideologia",
  "Desigualtat (Índex de Gini)"
)

p_indep_gini <- plot_blocs_factor(
  fac_indice_gini,
  independentista,
  "Independentisme",
  "Desigualtat (Índex de Gini)"
) +
  scale_fill_manual(values = colors_indep)

# IMMIGRACIÓ
p_ideo_imm <- plot_blocs_factor(
  fac_poblacio_no_espanyola,
  ideologia,
  "Ideologia",
  "Població no espanyola"
)

p_indep_imm <- plot_blocs_factor(
  fac_poblacio_no_espanyola,
  independentista,
  "Independentisme",
  "Població no espanyola"
) +
  scale_fill_manual(values = colors_indep)

p_ideo_edat <- plot_blocs_factor(
  fac_Edad_media,
  ideologia,
  "Ideologia",
  "Edat mitjana"
)

p_indep_edat <- plot_blocs_factor(
  fac_Edad_media,
  independentista,
  "Independentisme",
  "Edat mitjana"
) +
  scale_fill_manual(values = colors_indep)
```





```{r, fig.align='center', fig.pos = 'htbp', fig.cap='Renda segons blocs'}
(p_ideo_renda | p_indep_renda) 
```





```{r, fig.align='center', fig.pos = 'htbp', fig.cap='Gini segons blocs'}
(p_ideo_gini  | p_indep_gini) 
```




```{r, fig.align='center', fig.pos = 'htbp', fig.cap='Immigració segons blocs'}
(p_ideo_imm   | p_indep_imm)  
```



```{r,fig.align='center', fig.pos = 'htbp', fig.cap='Edat mitjana segons blocs'}
(p_ideo_edat  | p_indep_edat)
```


\newpage

## 5.2 Anàlisi de correspondències (CA) {#sec:resultats_ca}

Els gràfics de qualitat de representació ($cos^2$) i de contribució a les dimensions principals es troben a la secció: \nameref{sec:grafics_compl_ca}. A partir d’aquí, es dona per suposat que qualsevol referència a aquests aspectes es remet a aquesta secció per a la seva visualització.


### 5.2.1 Eleccions desembre 2015

```{r}
################################################################################
# ----- INCORPORACIÓ DADES -----
################################################################################

dades <- readRDS("dades_finals.rds") %>% 
  na.omit()

vars_socio <- c(
  "fac_Edad_media",
  "fac_Población",
  "fac_Tamaño_medio_del_hogar",
  "fac_renda_media_uc",
  "fac_indice_gini",
  "fac_poblacio_no_espanyola"
)

noms_curts <- c(
  "fac_Edad_media_Secció d'edat mitjana" = "Edat_Mitjana",
  "fac_Edad_media_Secció envellida" = "Edat_Alta",
  "fac_Edad_media_Secció jove" = "Edat_Baixa",
  "fac_Población_Població alta" = "Pob_Alta",
  "fac_Población_Població baixa" = "Pob_Baixa",
  "fac_Población_Població mitjana-alta" = "Pob_MitjanaAlta",
  "fac_Población_Població mitjana-baixa" = "Pob_MitjanaBaixa",
  "fac_Tamaño_medio_del_hogar_Llars grans" = "Llar_Gran",
  "fac_Tamaño_medio_del_hogar_Llars mitjanes" = "Llar_Mitjana",
  "fac_Tamaño_medio_del_hogar_Llars petites" = "Llar_Petita",
  "fac_indice_gini_Alta desigualtat" = "Gini_Alt",
  "fac_indice_gini_Baixa desigualtat" = "Gini_Baix",
  "fac_indice_gini_Desigualtat mitjana" = "Gini_Mitjà",
  "fac_poblacio_no_espanyola_Alta immigració" = "Immig_Alta",
  "fac_poblacio_no_espanyola_Baixa immigració" = "Immig_Baixa",
  "fac_poblacio_no_espanyola_Mitjana immigració" = "Immig_Mitjana",
  "fac_renda_media_uc_Renda alta" = "Renda_Alta",
  "fac_renda_media_uc_Renda baixa" = "Renda_Baixa",
  "fac_renda_media_uc_Renda mitjana" = "Renda_Mitjana",
  "fac_renda_media_uc_Renda molt alta" = "Renda_MoltAlta",
  "fac_renda_media_uc_Renda molt baixa" = "Renda_MoltBaixa"
)


llista_eleccions <- c("2015_des", "2016_jun", "2019_abr", "2019_nov", "2023_jul")
noms_eleccions   <- c("Desembre 2015", "Juny 2016", "Abril 2019", 
                      "Novembre 2019", "Juliol 2023")

################################################################################
# ----- CA I RESULTATS -----
################################################################################

plots_ca <- list()

for (i in seq_along(llista_eleccions)) {

  eleccio_id  <- llista_eleccions[i]
  eleccio_nom <- noms_eleccions[i]

  message("------------------------------------------------------------")
  message("Processant elecció: ", eleccio_nom)
  message("------------------------------------------------------------")

  dades_e <- dades %>% 
    filter(eleccio == eleccio_id) %>%
    select(eleccio, seccio, sigles, vots, all_of(vars_socio))

  matriu_ca <- dades_e %>%
    pivot_longer(cols = all_of(vars_socio),
                 names_to = "variable",
                 values_to = "categoria") %>%
    unite("var_cat", variable, categoria, sep = "_") %>%
    group_by(sigles, var_cat) %>%
    summarise(vots_total = sum(vots), .groups = "drop") %>%
    pivot_wider(names_from = var_cat,
                values_from = vots_total,
                values_fill = 0)

  colnames(matriu_ca) <- ifelse(
    colnames(matriu_ca) %in% names(noms_curts),
    noms_curts[colnames(matriu_ca)],
    colnames(matriu_ca)
  )

  matriu_ca <- matriu_ca %>% 
    column_to_rownames("sigles")

  matriu_ca <- matriu_ca[rowSums(matriu_ca) > 0, ]

  res.ca <- CA(matriu_ca, graph = FALSE)

  plots_ca[[eleccio_nom]] <- list()

  plots_ca[[eleccio_nom]]$biplot <- fviz_ca_biplot(
    res.ca,
    repel = TRUE,
    label = "all",
    col.row = "black",
    col.col = "blue",
    title = paste("CA - Partits i factors socioeconòmics (", eleccio_nom, ")")
  )

  plots_ca[[eleccio_nom]]$rows_cos2 <- fviz_ca_row(
    res.ca,
    col.row = "cos2",
    repel = TRUE,
    title = paste("Qualitat representació partits -", eleccio_nom)
  ) +
    scale_color_gradientn(
      colours = c("#00AFBB", "#E7B800", "#FC4E07"),
      limits = c(0, 1),
      values = c(0, 0.5, 1)
    )

  rows_contrib <- res.ca$row$contrib[, 1:2] %>%
    as.data.frame() %>%
    setNames(c("Dim.1", "Dim.2")) %>%
    tibble::rownames_to_column("nom") %>%
    pivot_longer(cols = c(Dim.1, Dim.2),
                 names_to = "Dimensio",
                 values_to = "Contribucio")

  plots_ca[[eleccio_nom]]$rows_contrib <- ggplot(
    rows_contrib,
    aes(x = reorder(nom, Contribucio), y = Contribucio, fill = Dimensio)
  ) +
    geom_col(position = "dodge") +
    coord_flip() +
    scale_fill_manual(values = c("Dim.1" = "#00AFBB", "Dim.2" = "#FC4E07")) +
    labs(
      title = paste("Contribució dels partits \nEleccions", eleccio_nom),
      x = "",
      y = "Contribució (%)"
    ) +
    theme_minimal(base_size = 13)

  plots_ca[[eleccio_nom]]$cols_cos2 <- fviz_ca_col(
    res.ca,
    col.col = "cos2",
    repel = TRUE,
    title = paste("Qualitat representació variables -", eleccio_nom)
  ) +
    scale_color_gradientn(
      colours = c("#00AFBB", "#E7B800", "#FC4E07"),
      limits = c(0, 1),
      values = c(0, 0.5, 1)
    )

  cols_contrib <- res.ca$col$contrib[, 1:2] %>%
    as.data.frame() %>%
    setNames(c("Dim.1", "Dim.2")) %>%
    tibble::rownames_to_column("nom") %>%
    pivot_longer(cols = c(Dim.1, Dim.2),
                 names_to = "Dimensio",
                 values_to = "Contribucio")

  plots_ca[[eleccio_nom]]$cols_contrib <- ggplot(
    cols_contrib,
    aes(x = reorder(nom, Contribucio), y = Contribucio, fill = Dimensio)
  ) +
    geom_col(position = "dodge") +
    coord_flip() +
    scale_fill_manual(values = c("Dim.1" = "#00AFBB", "Dim.2" = "#FC4E07")) +
    labs(
      title = paste("Contribució de les variables \nEleccions", eleccio_nom),
      x = "",
      y = "Contribució (%)"
    ) +
    theme_minimal(base_size = 13)
}
```

```{r ca2015, fig.cap="CA de les eleccions del desembre del 2015.", fig.width=12, fig.height=5, fig.pos='H',fig.show='hold'}
plots_ca$`Desembre 2015`$biplot
```

Com mostra la Figura 1, les dues primeres dimensions expliquen el 88,9% de la variabilitat total, cosa que permet identificar amb claredat les associacions entre partits polítics i variables socioeconòmiques. Tot i això, VOX i Cs presenten una qualitat de representació molt baixa inferior a 0,20 en termes de $cos^2$, fet que limita la fiabilitat de la seva posició en el mapa factorial i en dificulta la interpretació.

L’anàlisi factorial mostra que la Dimensió 1 està principalment explicada pels partits CONV./JxCAT i PSC/PSOE, a més de ERC que presenten les contribucions més elevades. Aquesta dimensió s’associa sobretot amb variables socioeconòmiques relacionades amb la renda molt baixa i molt alta, així com amb nivells elevats de desigualtat (Gini alt), indicant un eix de diferenciació socioeconòmica clara.
La Dimensió 2 està dominada principalment pel PP a més de ERC i ECP/SUMAR, amb contribucions rellevants també de variables de renda i alguns grups d’edat. Aquest eix sembla captar diferències més vinculades a perfils socials intermedis i estructurals.
En canvi, partits com VOX i CS presenten contribucions molt baixes en ambdues dimensions, indicant un paper poc rellevant en l’estructura factorial.
Pel que fa a les variables, les relacionades amb immigració, mida de la llar i població tenen una contribució menor, i per tant un pes reduït en la definició dels eixos principals.

Considerant únicament les categories amb bona qualitat de representació, l’anàlisi mostra que CONV./JxCAT se situa associat a municipis amb nivells elevats de renda (renda alta i molt alta) i major desigualtat (Gini alt), així com amb una població de més edat. En el mateix eix socioeconòmic, però amb una posició menys extrema, es troba ERC, que s’associa a perfils intermedis, llars de mida petita i nivells més baixos d’immigració. En canvi, PSC/PSOE es posiciona en el costat oposat de la Dimensió 1, mostrant una clara associació amb renda baixa, menor desigualtat i població més jove, una tendència que també comparteix parcialment ECP/SUMAR. El PP presenta una associació amb renda alta i edat elevada, especialment captada per la segona dimensió. Finalment, CS i VOX mostren una qualitat de representació baixa i no es poden interpretar de manera fiable en el pla factorial.

### 5.2.2 Eleccions juny 2016

```{r ca2016, fig.cap="CA de les eleccions de juny del 2016.", fig.width=12, fig.height=5, fig.pos='H',fig.show='hold'}

plots_ca$`Juny 2016`$biplot
```

Les dues primeres dimensions expliquen el 91.2% de la variabilitat total, cosa que permet identificar amb claredat les associacions entre partits polítics i variables socioeconòmiques. Respecte les eleccions anteriors podem veure una millor representació de VOX, tot i que encara no acaba de estar ben representada. En cambi Cs presenta una qualitat de representació molt baixa inferior a 0,20 en termes de $cos^2$, fet que limita la fiabilitat de la seva posició en el mapa factorial i en dificulta la interpretació.

L’anàlisi factorial mostra que la Dimensió 1 està principalment explicada pels partits CONV./JxCAT i PSC/PSOE, a més de ERC que presenten les contribucions més elevades. Aquesta dimensió s’associa sobretot amb variables socioeconòmiques relacionades amb la renda molt baixa i molt alta, així com amb nivells elevats de desigualtat (Gini alt), indicant un eix de diferenciació socioeconòmica clara.
La Dimensió 2 està dominada principalment pel PP a més de ERC i ECP/SUMAR, amb contribucions rellevants també de variables de renda i alguns grups d’edat. Aquest eix sembla captar diferències més vinculades a perfils socials intermedis i nivell d'immigració.
En canvi, partits com VOX i CS presenten contribucions molt baixes en ambdues dimensions, indicant un paper poc rellevant en l’estructura factorial.
Pel que fa a les variables, les relacionades amb Edat, mida de la llar i població tenen una contribució menor, i per tant un pes reduït en la definició dels eixos principals.

Considerant únicament les categories amb bona qualitat de representació, l’anàlisi mostra que CONV./JxCAT se situa associat a municipis amb nivells elevats de renda (renda alta i molt alta) i major desigualtat (Gini alt), així com amb una població de més edat. En el mateix eix socioeconòmic, però amb una posició menys extrema, es troba ERC, que s’associa a perfils intermedis, llars de mida petita i nivells més baixos d’immigració. En canvi, PSC/PSOE es posiciona en el costat oposat de la Dimensió 1, mostrant una clara associació amb renda baixa, menor desigualtat i població més adulta, una tendència que també comparteix parcialment ECP/SUMAR. El PP presenta una associació amb renda alta i edat elevada, especialment captada per la segona dimensió. Finalment, CS i VOX mostren una qualitat de representació baixa i no es poden interpretar de manera fiable en el pla factorial.

### 5.2.3 Eleccions abril 2019

```{r ca2019a, fig.cap="CA de les eleccions de l'abril del 2019.", fig.width=12, fig.height=5, fig.pos='H',fig.show='hold'}
plots_ca$`Abril 2019`$biplot
```

Les dues primeres dimensions expliquen el 92,8% de la variabilitat total, cosa que permet identificar amb claredat les associacions entre partits polítics i variables socioeconòmiques. Ara sembla que totes les variables estan ben representades en termes de $cos^2$ (totes >0.5), fet que aporta fiabilitat de la seva posició en el mapa factorial i en dificulta la interpretació.

L’anàlisi factorial mostra que la Dimensió 1 està principalment explicada pels partits CONV./JxCAT i PSC/PSOE, a més de ERC que presenten les contribucions més elevades. Aquesta dimensió s’associa sobretot amb variables socioeconòmiques relacionades amb la renda molt baixa i molt alta, així com amb nivells elevats de desigualtat (Gini alt i baix), indicant un eix de diferenciació socioeconòmica clara.
La Dimensió 2 està dominada principalment pel PP a més de ERC i ECP/SUMAR, amb contribucions rellevants també de variables de desigualtat gini, renda i immigració. Aquest eix sembla captar diferències més vinculades a perfils socials amb desigualtats i estructurals.
En canvi, partits com VOX i CS presenten contribucions molt baixes en ambdues dimensions tot i que més elevada que en les eleccions anteriors.
Pel que fa a les variables, les relacionades amb  mida de la llar i població tenen una contribució menor, i per tant un pes reduït en la definició dels eixos principals.

L’anàlisi mostra que CONV./JxCAT se situa associat a seccions censals amb nivells elevats de renda (renda alta i molt alta) i major desigualtat (Gini alt), així com amb una població de més edat i més petita. En el mateix eix socioeconòmic, però amb una posició menys extrema, es troba ERC, que s’associa a perfils amb renda mitjana-alta, llars de mida petita i nivells més baixos d’immigració. En canvi, PSC/PSOE es posiciona  mostrant una clara associació amb renda baixa-molt baixa, menor desigualtat i població més jove, una tendència que també comparteix parcialment ECP/SUMAR. El PP presenta una associació amb renda alta i edat elevada, però especialment amb seccions amb gini alt. Finalment, CS i VOX mostren asociació amb rendes baixes-molt baixes, llars grans e immigració alta.



### 5.2.4 Eleccions novembre 2019


```{r ca2019n, fig.cap="CA de les eleccions del novembre del 2019.", fig.width=12, fig.height=5, fig.pos='H',fig.show='hold'}

plots_ca$`Novembre 2019`$biplot
```

Les dues primeres dimensions expliquen el 93.4% de la variabilitat total, cosa que permet identificar amb claredat les associacions entre partits polítics i variables socioeconòmiques. Totes les variables estan ben representades en termes de $cos^2$ (totes >0.5), fet que aporta fiabilitat de la seva posició en el mapa factorial i en dificulta la interpretació. Podem destacar l'aparició de la CUP com a partit ben representat.

L’anàlisi factorial mostra que la Dimensió 1 està principalment explicada pels partits CONV./JxCAT i PSC/PSOE, a més de ERC que presenten les contribucions més elevades. Aquesta dimensió s’associa sobretot amb variables socioeconòmiques relacionades amb la renda molt baixa i molt alta, així com amb nivells elevats de desigualtat (Gini alt i baix), indicant un eix de diferenciació socioeconòmica clara.
La Dimensió 2 està dominada principalment pel PP i ERC, podem destacar la caiguda en contribució de ECP/SUMAR respecte eleccions anteriors, amb contribucions rellevants també de variables de renda i nivells d'immigració. Aquest eix sembla captar diferències més vinculades a desigualtats socials i estructurals.
En canvi, partits com VOX, CS,CUP i ECP/SUMAR presenten contribucions molt baixes en ambdues dimensions, indicant un paper poc rellevant en l’estructura factorial.
Pel que fa a les variables, les relacionades amb edat, mida de la llar i població tenen una contribució menor, i per tant un pes reduït en la definició dels eixos principals.

L’anàlisi mostra que CONV./JxCAT se situa associat a seccions censals amb nivells elevats de renda (renda alta i molt alta) i major desigualtat (Gini alt), així com amb una població de més edat i més petita. En el mateix eix socioeconòmic, però amb una posició menys extrema, es troba ERC i CUP, que s’associen a perfils amb renda mitjana-alta, llars de mida petita i nivells més baixos d’immigració. En canvi, PSC/PSOE es posiciona  mostrant una clara associació amb renda baixa-molt baixa, menor desigualtat i població més jove, una tendència que també comparteix parcialment ECP/SUMAR. El PP presenta una associació amb renda alta i edat elevada, però especialment amb seccions amb gini alt. Finalment, CS i VOX mostren asociació amb rendes baixes-molt baixes, llars grans e immigració alta.

### 5.2.5 Eleccions juliol 2023


```{r ca2023, fig.cap="CA de les eleccions de juliol del 2023.", fig.width=12, fig.height=5, fig.pos='H',fig.show='hold'}

plots_ca$`Juliol 2023`$biplot
```

Les dues primeres dimensions expliquen el 92.1% de la variabilitat total, cosa que permet identificar amb claredat les associacions entre partits polítics i variables socioeconòmiques. Tot i això, ECP/SUMAR presenta una qualitat de representació molt baixa inferior a 0,20 en termes de $cos^2$, fet que limita la fiabilitat de la seva posició en el mapa factorial i en dificulta la interpretació. Destaca que a les primeres eleccions tenía una contribució alta i que poc a poc ha anant baixat amb l'augment de constribucions d'altres partits. El mateix cas amb Cs que directament desapareix de l'analisi.


L’anàlisi factorial mostra que la Dimensió 1 està principalment explicada pels partits CONV./JxCAT, VOX i PSC/PSOE, en aquestes eleccions també contribueix VOX, que presenta les contribucions elevades. Aquesta dimensió s’associa sobretot amb variables socioeconòmiques relacionades amb les rendes i edat, indicant un eix de diferenciació socioeconòmica clara.

La Dimensió 2 està dominada principalment pel PP a més de ERC, amb contribucions rellevants en categories de desigualtat (gini) i tamany de la llar. Aquest eix sembla captar desigualtats i tamanys de les llars.
En canvi, partits com ECP/SUMAR i CUP presenten contribucions molt baixes en ambdues dimensions, indicant un paper poc rellevant en l’estructura factorial.
Pel que fa a les variables, les relacionades amb immigració i població tenen una contribució menor, i per tant un pes reduït en la definició dels eixos principals.

Considerant únicament les categories amb bona qualitat de representació, l’anàlisi mostra que CONV./JxCAT se situa associat a municipis amb nivells elevats de renda (renda alta i molt alta) i major desigualtat (Gini alt), així com amb una població de més edat. En el mateix eix socioeconòmic, però amb una posició menys extrema, es troba ERC i la CUP, que s’associen a perfils amb rendes altes, llars de mida petita i gini mitjà. En canvi, PSC/PSOE es posiciona mostrant una clara associació amb renda baixa-molt baixa, menor desigualtat i població més jove. El PP presenta una associació amb renda alta i edat elevada, a més de desigualtat gran especialment captada per la segona dimensió. Finalment VOX s'asocia amb rendes baixes i molt baixes,immigració alta i edat baixa.




## 5.3 Modelització estadística

### 5.3.1 Selecció de models mixtes

Atesa la naturalesa de les dades, amb observacions repetides a nivell de secció censal al llarg de les eleccions, vam utilitzar models lineals mixtes. Aquests models permeten combinar efectes fixos (associats a característiques socioeconòmiques observables de cada secció) amb efectes aleatoris que capturen diferències no observades. Ens va semblar coherent pensar que cada secció censal pot presentar una certa “personalitat política” pròpia, mentre que cada elecció té un context específic. Aquest fet pot desplaçar el nivell mitjà de suport electoral. L’ús de models mixtes permet capturar aquests nivells variabilitat.

Pel que fa als efectes fixos, la combinació de variables que va mostrar un millor rendiment en presència de la resta de covariables va ser:
Edat Mitjana, Població, elecció, Mida mitjana de la llar, Renda mitjana per unitat de consum, índex de Gini i Població no espanyola. Aquesta selecció es va fer tenint en compte tant el seu rendiment en presència de la resta de variables com la necessitat de minimitzar problemes de multicol·linealitat, motiu pel qual no es van incloure simultàniament diferents mesures alternatives de renda.

A partir d’aquesta especificació, es van considerar quatre configuracions alternatives d’efectes aleatoris, que poden expressar-se esquemàticament de la manera següent:

$$ \text{Model 1: } \text{logit(Pct)} \sim X + (1 \mid \text{seccio}) + (1 \mid \text{eleccio}) $$

$$ \text{Model 2: } \text{logit(Pct)} \sim X + \text{eleccio} + (1 \mid \text{seccio}) $$

$$ \text{Model 3: } \text{logit(Pct)} \sim X + (1 \mid \text{seccio}) $$

$$ \text{Model 4: } \text{logit(Pct)} \sim X + (1 \mid \text{eleccio}) $$

on $X$ representa el conjunt d’efectes fixos socioeconòmics descrits anteriorment.

### 5.3.2 Model òptim

Finalment, els models es van comparar utilitzant els criteris d’informació AIC i BIC, així com el nombre de paràmetres estimats. D’acord amb aquests criteris, el Model 1, que incorpora interceptes aleatoris tant per secció censal com per elecció, va resultar el més adequat, indicant que ambdós nivells contribueixen de manera rellevant a explicar la variabilitat del suport electoral.

## 5.4 Models d'Aprenentatge Automàtic


Per complementar l’anàlisi factorial i els models estadístics més habituals, es van ajustar models d’aprenentatge automàtic supervisat. La idea era poder captar relacions no lineals i interaccions que els models tradicionals no captaven bé. Es van utilitzar dos tipus d’arbres de decisió: Random Forest i Extreme Gradient Boosting.

Aquests models van permetre modelar patrons no lineals i van facilitar l’anàlisi del paper de les variables socioeconòmiques en la predicció del suport electoral. L’objectiu principal d’aquesta secció va ser identificar quins factors del territori explicaven millor la variabilitat en el suport als diferents partits polítics.

Els models es van fer per separat, elecció per elecció i partit per partit. Com a variable a predir es va agafar la quota de vot per secció censal, i només es van incloure indicadors socioeconòmics i demogràfics com a predictors. D’aquesta manera, es podia veure directament l’efecte del territori sense que altres característiques de l’elecció o del partit interferissin.

En alguns models, els valors SHAP de variables altament correlacionades, com `renda mitjana per persona` i `renda mitjana per llar`, mostren signes oposats. Aquestes poden reflectir diferències de patró local: per exemple, en zones amb llars grans, l’efecte de renda per llar podria diferir de la renda per persona. La literatura indica que això és una conseqüència esperable de la colinearitat: els arbres poden utilitzar una variable per fer particions i assignar l’efecte restant a l’altra variable, generant valors SHAP amb signe contrari (@lundberg2017, @molnar2020, @hooker2007). Això no reflecteix un efecte negatiu real, sinó una distribució arbitrària de la contribució entre variables correlacionades.

Per garantir una interpretació correcta, s’ha modelat per separat per tal de poder combinar-ho posteriorment si es volgués interpretar l’efecte combinat de les variables de renda com una dimensió socioeconòmica comuna, considerant així la direcció i magnitud neta de l’impacte sobre la quota de vot.

Com expliquen @hastie2009 i @molnar2020 utilitzar variables correlacionades no necessariament degraden el rendiment del model. Ja que els arbres son capaços d'escollir quina de les variables correlacionades utilitzar per fer les particions. Per tant, la predicció final pot ser òptima tot i la possiblement innecessaria complexitat del model.

Així que tot i que `renda mitjana per persona` i `renda mitjana per llar` estan correlacionades, la literatura indica que, si el model pot distingir patrons específics de cada variable i hi ha suficient variabilitat en les dades, els valors SHAP poden ser interpretats per separat (@lundberg2017; @molnar2020). Això permet observar com la quota de vot respon diferencialment a la renda individual i a la renda del conjunt de la llar, mantenint la validesa de la interpretació, encara que s'ha d'inspeccionar cuidadosament els valors SHAP per treure qualsevol conclusió.


### 5.4.1 Random Forest (RF)

L’estratègia de modelització amb Random Forest va tenir com a objectiu capturar patrons específics de comportament electoral a nivell de secció censal. En lloc d’estimar un únic model global, es va entrenar un model independent per a cada combinació d’elecció i sigla, amb la finalitat d’analitzar de manera diferenciada els determinants socioeconòmics del suport relatiu a cada formació política.

La variable dependent es va definir com la quota de vot per partit i secció censal, calculada com la proporció de vots obtinguts per una sigla sobre el total de vots emesos a la secció en una convocatòria electoral determinada:

$$quota_{p,s,c} = \frac{vots_{p,s,c}}{\sum vots_{p,s,c}}$$

on $p$ denota el partit política, $s$ denota la secció censal i $c$ la convocatòria electoral.

Del conjunt original de variables es van excloure aquelles que identificaven directament el context electoral o la unitat administrativa, així com variables polítiques o identificatives (any, municipi, districte, nom del partit, sigles, ideologia, independentisme, entre d’altres). D’aquesta manera, el model es va construir únicament a partir d’indicadors socioeconòmics i demogràfics a nivell de secció censal, assegurant que la capacitat explicativa del model s’atribuís exclusivament a factors estructurals del territori.

Per a cada elecció i sigla, les dades es van dividir en conjunts d’entrenament (80%) i test (20%) mitjançant una partició per grups basada en la secció censal. Aquest procediment va garantir que totes les observacions corresponents a una mateixa secció quedessin íntegrament assignades al mateix conjunt, evitant fuites d’informació entre conjunts i assegurant una avaluació més realista de la capacitat de generalització del model.

Es va establir un llindar mínim de 50 observacions per estimar un model per partit i elecció. En els casos en què aquest volum no es va assolir, el model no es va entrenar per evitar resultats inestables o amb baixa fiabilitat estadística.

L’entrenament del Random Forest es va dur a terme mitjançant validació creuada de 5 plecs sobre el conjunt d’entrenament, utilitzant el paquet `caret`. L’únic hiperparàmetre optimitzat de manera explícita va ser el nombre de variables considerades a cada partició (mtry), que controla el grau d’aleatorització entre arbres i l’equilibri entre biaix i variància del model. Per a cada valor candidat, es va estimar el rendiment mitjà en validació creuada i es va seleccionar el paràmetre que minimitzava l’error de predicció.

El rendiment del model es va avaluar sobre el conjunt de test mitjançant tres indicadors estàndard en regressió: l’error quadràtic mitjà (RMSE), l’error absolut mitjà (MAE) i el coeficient de determinació($R^2$).

Per abordar la interpretabilitat del model, es va incorporar una anàlisi basada en valors SHAP (SHapley Additive exPlanations), que permet descompondre cada predicció en contribucions additives atribuïbles a cada variable explicativa. Els valors SHAP es van estimar sobre una mostra aleatòria del conjunt d’entrenament (fins a un màxim de 500 observacions per model) mitjançant un procediment de simulació per permutacions. Per a una observació $x$ i una variable $j$, el valor del SHAP $\phi_j(x)$ mesura la contribució marginal esperada de $j$ a la predicció del model, promediada sobre totes les possibles combinacions de variables. 

A partir d’aquests valors, es van construir dos tipus d’anàlisi. En primer lloc, una mesura d’importància global, definida com la mitjana del valor absolut dels SHAP per variable, que identifica quins factors socioeconòmics presenten un impacte mitjà més elevat sobre la quota de vot predita. En segon lloc, una anàlisi direccional acumulada (waterfall), que permet visualitzar la direcció i la magnitud mitjana de l’efecte de cada variable sobre la predicció, distingint entre contribucions positives i negatives.

Aquest enfocament va facilitar la comparació sistemàtica entre partits i eleccions, posant de manifest quins eixos socioeconòmics van resultar sistemàticament rellevants i quins van emergir de manera més dependent del context electoral.

### 5.4.2 XGBoost

El model Extreme Gradient Boosting (XGBoost) es va implementar com un enfocament complementari al Random Forest, amb l’objectiu d’explorar si un esquema d’optimització seqüencial dels arbres millorava la capacitat predictiva en la predicció de la quota de vot i permetia captar patrons socioeconòmics més subtils.

A diferència del Random Forest, que construeix els arbres de manera independent i paral·lela, XGBoost adopta una estratègia de boosting, en què cada arbre s’entrena per corregir els errors residuals acumulats pels arbres anteriors. La predicció del model després de $K$ iteracions es va expressar com:

$$\hat{y}_i=\sum_{k=1}^K f_k(x_i)$$

on cada $f_k$ correspon a un arbre de regressió que contribueix de manera additiva a la predicció final per a l’observació $i$.

Per garantir la comparabilitat amb Random Forest, el model XGBoost es va aplicar sobre els mateixos conjunts de dades i amb el mateix disseny experimental: La variable resposta es va definir com la quota de vot per partit i secció censal. Els predictors es van limitar a variables socioeconòmiques i demogràfiques. Es va mantenir la partició en conjunts d’entrenament i test per grups de secció censal. Es van utilitzar les mateixes mètriques d’avaluació: RMSE, MAE i $R^2$.

L’entrenament es va centrar en controlar la complexitat del model mitjançant paràmetres com la profunditat màxima dels arbres, la taxa d’aprenentatge (learning rate) i el nombre d’iteracions. Aquesta regulació va permetre equilibrar la capacitat explicativa i el risc de sobreajustament, especialment rellevant en un context amb múltiples predictors correlacionats.

Els arbres es van entrenar de manera seqüencial, corregint els errors residus dels arbres anteriors, fet que va permetre capturar interaccions específiques i relacions no lineals menys evidents, que podrien no ser detectades pel Random Forest.

Metodològicament, Random Forest tendeix a capturar patrons robustos mitjançant l’agregació d’arbres independents, mentre que XGBoost és especialment sensible a interaccions concretes i a relacions no lineals fines entre variables. Aquesta diferència es va reflectir en la seva capacitat per millorar la predicció en partits o eleccions amb patrons socioeconòmics més heterogenis o menys homogènies territorialment. La comparació sistemàtica de les mètriques d’avaluació entre ambdós models va permetre identificar en quins contextos l’optimització seqüencial aportava millores reals de rendiment i en quins casos l’estabilitat del Random Forest resultava suficient.


\newpage
# 6. Validació dels models

## 6.1 Estratègia de validació

La validació del model seleccionat per a cada partit es realitza mitjançant una anàlisi exhaustiva dels residus de Pearson, amb l’objectiu de verificar el compliment dels supòsits del model lineal mixt.

En primer lloc, es representa la relació entre els residus i els valors ajustats per avaluar la presència de patrons sistemàtics, cosa que permet detectar possibles problemes de no linealitat o heteroscedasticitat.

A continuació, s’analitza la distribució dels residus mitjançant un histograma i un gràfic quantil-quantil (QQ-plot) per comprovar la compatibilitat amb l’assumpció de normalitat, essencial per a la validesa de la inferència sobre els coeficients del model.

Finalment, es calcula la funció d’autocorrelació (ACF) i l’autocorrelació parcial (PACF) dels residus per detectar possibles dependències temporals o estructurals entre observacions corresponents a diferents eleccions. Aquesta anàlisi permet verificar si l’efecte aleatori associat al nivell “elecció” captura adequadament la correlació entre observacions repetides en el temps.

En conjunt, aquesta estratègia garanteix tant la qualitat de l’ajust estadístic com la coherència estructural del model en relació amb la jerarquia territorial i temporal de les dades electorals.

## 6.2 Validació del model lineal òptim

```{r, echo=FALSE, include=FALSE}
################################################################################
# ----- INCORPORACIÓ DADES I TRANSFORMACIÓ A LOGIT -----
################################################################################

dades <- readRDS("dades_finals.rds")

dades <- dades %>%
  group_by(seccio, eleccio) %>%
  mutate(
    total_vots = sum(vots),
    pct_vot = 100 * vots / total_vots
  ) %>%
  ungroup()

dades <- dades %>%
  mutate(
    pct_vot_adj = pmin(pmax(pct_vot, 0.1), 99.9),
    logit_pct_vot = log(pct_vot_adj / (100 - pct_vot_adj))
  )

dades <- dades %>% 
  dplyr::select(
    sigles, seccio, eleccio, logit_pct_vot,
    fac_Edad_media, fac_Población, fac_Tamaño_medio_del_hogar,
    fac_renda_media_uc, fac_indice_gini, fac_poblacio_no_espanyola
  ) %>%
  dplyr::rename(
    `Edat Mitjana` = fac_Edad_media,
    `Població` = fac_Población,
    `Mida mitjana llar` = fac_Tamaño_medio_del_hogar,
    `Renda mitjana uc` = fac_renda_media_uc,
    `índex Gini` = fac_indice_gini,
    `Població no espanyola` = fac_poblacio_no_espanyola
  ) %>%
  na.omit()


################################################################################
# ----- MODEL LINEAL PER PARTIT -----
################################################################################

partits <- c("CONV./JxCAT", "CS", "CUP/PR", "ECP/SUMAR",
             "ERC", "PP", "PSC/PSOE", "VOX")

models_final <- list()

for (partit in partits) {
  
  cat("\n=============================\n")
  cat("Model per al partit:", partit, "\n")
  cat("=============================\n")
  
  dades_partit <- dades %>% filter(sigles == partit) %>% 
    dplyr::select(-sigles, -seccio)
  
  model_full <- lm(logit_pct_vot~., data = dades_partit)
  
  models_final[[partit]] <- model_full
  
  print(summary(model_full))
}


################################################################################
# ----- MODELS MIXTES PER PARTIT -----
################################################################################

models_mixtes <- list()

for (partit in partits) {
  
  cat("\n==================================\n")
  cat("Models mixtes per al partit:", partit, "\n")
  cat("==================================\n")
  
  dades_partit <- dades %>%
    filter(sigles == partit) %>%
    droplevels()
  
  # MODEL 1: iid per secció i elecció
  model1 <- lmer(
    logit_pct_vot ~ `Edat Mitjana` + `Població` +
      `Mida mitjana llar` + `Renda mitjana uc` +
      `índex Gini` + `Població no espanyola` +
      (1 | seccio) + (1 | eleccio),
    data = dades_partit
  )
  
  # MODEL 2: eleccio efecte fix + iid seccio
  model2 <- lmer(
    logit_pct_vot ~ `Edat Mitjana` + `Població` + eleccio +
      `Mida mitjana llar` + `Renda mitjana uc` +
      `índex Gini` + `Població no espanyola` +
      (1 | seccio),
    data = dades_partit
  )

  # MODEL 3: només iid secció
  model3 <- lmer(
    logit_pct_vot ~ `Edat Mitjana` + `Població` +
      `Mida mitjana llar` + `Renda mitjana uc` +
      `índex Gini` + `Població no espanyola` +
      (1 | seccio),
    data = dades_partit
  )
  
  # MODEL 4: només iid elecció
  model4 <- lmer(
    logit_pct_vot ~ `Edat Mitjana` + `Població` +
      `Mida mitjana llar` + `Renda mitjana uc` +
      `índex Gini` + `Població no espanyola` +
      (1 | eleccio),
    data = dades_partit
  )
  
  models_mixtes[[partit]] <- list(
    model1 = model1,
    model2 = model2,
    model3 = model3,
    model4 = model4
  )
}


################################################################################
# ----- AVALUACIÓ DELS MODELS PER CADA PARTIT -----
################################################################################

n_param <- function(model) {
  if (inherits(model, "lm")) {
    return(length(coef(model)))
  }
  if (inherits(model, "lmerMod")) {
    return(length(fixef(model)) + length(getME(model, "theta")))
  }
  return(NA)
}

icc_from_lmer <- function(model) {
  vc <- as.data.frame(VarCorr(model))
  var_re <- sum(vc$vcov[vc$grp != "Residual"])
  var_res <- vc$vcov[vc$grp == "Residual"]
  icc <- var_re / (var_re + var_res)
  return(icc)
}

resultats_models <- list()

for (partit in partits) {
  
  cat("\n==================================\n")
  cat("Avaluació models per al partit:", partit, "\n")
  cat("==================================\n")
  
  mods_mixtes <- models_mixtes[[partit]]
  mod_lm <- models_final[[partit]]
  
  df_res <- data.frame(
    model = character(),
    AIC = numeric(),
    BIC = numeric(),
    ICC = character(),
    n_param = numeric(),
    stringsAsFactors = FALSE
  )
  
  df_res <- rbind(
    df_res,
    data.frame(
      model = "model0",
      AIC = AIC(mod_lm),
      BIC = BIC(mod_lm),
      ICC = "-",
      n_param = n_param(mod_lm)
    )
  )
  
  for (nom_model in names(mods_mixtes)) {
    m <- mods_mixtes[[nom_model]]
    df_res <- rbind(
      df_res,
      data.frame(
        model = nom_model,
        AIC = AIC(m),
        BIC = BIC(m),
        ICC = sprintf("%.3f", icc_from_lmer(m)),
        n_param = n_param(m)
      )
    )
  }
  
  colnames(df_res)[colnames(df_res) == "n_param"] <- "Núm. Paràm."
  colnames(df_res)[colnames(df_res) == "model"] <- "Model"
  
  print(df_res)
  resultats_models[[partit]] <- df_res
}


colors_partits <- c(
  "PSC/PSOE"    = "#E30613",
  "PP"          = "#1D4ED8",
  "ERC"         = "#FFB90F",
  "CONV./JxCAT" = "#76EEC6",
  "CUP/PR"      = "#FFD700",
  "CS"          = "#F97316",
  "VOX"         = "#00FF00",
  "ECP/SUMAR"   = "#7C3AED"
)

taules_kable <- list()

for (partit in names(resultats_models)) {
  
  df <- resultats_models[[partit]]
  
  idx_best <- which.min(df$BIC)
  
  # Eliminem la columna "Model òptim"
  # (si existeix d'iteracions anteriors)
  df$`Model òptim` <- NULL
  
  kbl_tbl <- df %>%
    kbl(
      caption = paste("Models per al partit:", partit),
      align = "c",
      digits = 3,
      escape = FALSE
    ) %>%
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed"),
      full_width = FALSE,
      font_size = 15
    ) %>%
    row_spec(
      idx_best,
      bold = TRUE,
      underline = TRUE,   # <<–– SUBRATLLAT DEL MILLOR MODEL
      color = "black"
    ) %>%
    add_header_above(
      c(" " = 1, "Mètriques dels models" = 4),
      bold = TRUE,
      background = "#f0f0f0"
    ) %>%
    column_spec(1, bold = TRUE) %>%
    kable_classic(html_font = "Helvetica") %>%
    footnote(
      general = "El model subratllat és el que presenta el BIC més baix.",
      general_title = "",
      footnote_as_chunk = TRUE
    )
  
  taules_kable[[partit]] <- kbl_tbl
}
```


```{r}
for (partit in partits) {
  
  model_sel <- models_mixtes[[partit]]$model1
  
  cat("\n===========================================\n")
  cat("VALIDACIÓ DEL MODEL ", partit, "\n")
  cat("===========================================\n")
  
  # Layout 2x3 per mostrar els 5 gràfics junts
  par(mfrow = c(2, 3))
  
  # 1. Residus vs ajustats
  plot(
    residuals(model_sel, type = "pearson") ~ fitted(model_sel),
    main = paste("Residus vs Valors ajustats ", partit),
    xlab = "Valors ajustats",
    ylab = "Residus (Pearson)"
  )
  abline(h = 0, col = "red", lty = 2)
  
  # 2. Histograma
  hist(
    residuals(model_sel, type = "pearson"),
    breaks = 15,
    main = paste("Histograma dels residus ", partit),
    xlab = "Residus (Pearson)"
  )
  
  # 3. QQ-plot
  qqnorm(
    residuals(model_sel, type = "pearson"),
    main = paste("QQ-plot dels residus ", partit)
  )
  qqline(residuals(model_sel, type = "pearson"), col = "red")
  
  # 4. ACF
  acf(
    residuals(model_sel, type = "pearson"),
    main = paste("ACF dels residus ", partit)
  )
  
  # 5. PACF
  pacf(
    residuals(model_sel, type = "pearson"),
    main = paste("PACF dels residus ", partit)
  )
  
  # (Opcional) espai buit al sisè panell
  plot.new()
}
```


CONV./JxCAT: Vot més alt en zones amb renda elevada i població envellida. Vot més baix en zones amb alta immigració o població densa. $R^2$ = 0.364, model amb ajust moderat.

CS: Vot més alt en zones poblades i menys envellides. Vot més baix en zones riques. $R^2$ = 0.370, ajust similar a JxCAT.

CUP/PR: Vot alt en zones riques i amb renda alta. Vot baix en zones envellides i densament poblades. $R^2$ = 0.422, millor explicació del vot entre partits petits.

ECP/SUMAR: Vot més alt en zones amb alta immigració i població mitjana. Menys vot en zones riques i envellides. $R^2$ = 0.388, ajust moderat.

ERC: Patró similar a JxCAT, amb vot més alt en zones riques i menys immigració. $R^2$ = 0.369, ajust moderat.

PP: Vot alt en zones envellides, poblades i amb més immigració. Vot menor en zones riques. $R^2$ = 0.456, model amb millor explicació del vot.

PSC/PSOE: Vot més alt en zones poblades i amb més immigració. Vot menor en zones riques i envellides. $R^2$ = 0.527 → millor ajust global.

VOX: Vot alt en zones poblades i envellides, menys afectat per immigració. Vot menor en zones riques. $R^2$de 0.654, millor ajust entre tots els partits.

L’ús d’efectes aleatoris territorials va millorar l’ajust del model, especialment per VOX, PP i PSC/PSOE, amb ICC elevats (>0.8), indicant que gran part de la variabilitat del vot depèn de factors regionals o locals no capturats pels efectes fixos. Els models mixtes permeten una predicció més fiable a nivell territorial i expliquen millor la dispersió observada entre seccions censals.

En primer lloc, l’examen de les funcions d’autocorrelació (ACF) i d’autocorrelació parcial (PACF) dels residus indica la presència d’autocorrelació significativa, especialment a llargues distàncies. Això suggereix que els models no capten completament la dependència entre seccions censals ni entre diferents períodes electorals, la qual cosa podria afectar la precisió de les prediccions.

A més, la distribució dels residus no està totalment centrada en zero i mostra certa asimetria i curtosi. Aquesta desviació del supòsit de normalitat inherent als models lineals clàssics implica que els errors estàndard dels coeficients podrien estar subestimats i, per tant, les proves d’hipòtesi (t i F) podrien ser menys fiables.

Els resultats també suggereixen que hi ha efectes no captats pel model, possiblement deguts a factors locals o interaccions complexes entre variables sociodemogràfiques. Això inclou, per exemple, dinàmiques entre seccions censals veïnes, efectes temporals derivats de resultats electorals previs o relacions no lineals entre renda, població i altres característiques sociodemogràfiques.

Com a conseqüència, tot i que els models permeten identificar patrons generals i associacions significatives entre variables explicatives i el vot, els coeficients estimats poden ser esbiaixats i les prediccions per a seccions concretes podrien no reflectir completament la realitat.

Per millorar l’adequació dels models, es podrien considerar alternatives més complexes, com ara models lineals generalitzats amb distribucions adequades per a proporcions, models espacials o autoregressius per capturar dependències geogràfiques, o bé la inclusió d’interaccions i transformacions no lineals de les variables explicatives.

En aquest treball, el BIC s’ha utilitzat com a criteri principal per seleccionar el model òptim per a cada partit, prioritzant solucions més parsimonioses que ofereixin un bon equilibri entre qualitat d’ajust i simplicitat estructural. Una altra mètrica rellevant és el nombre de paràmetres estimats en cada model, que inclou tant els efectes fixos com els components de variància dels efectes aleatoris. Aquesta mesura permet avaluar explícitament el cost en complexitat de cada especificació i contextualitzar les diferències observades en AIC i BIC.

Addicionalment, s’ha calculat el coeficient de correlació intraclasse (ICC) per als models mixtes, amb l’objectiu de quantificar la proporció de la variància total atribuïble als efectes aleatoris associats a les seccions censals i/o a les eleccions. Valors elevats d’ICC indiquen que una part substancial de la variabilitat del vot es deu a diferències estructurals entre unitats territorials o períodes electorals, justificant l’ús de models jeràrquics en lloc de models lineals simples.

Malgrat que les mètriques d’ajust i els criteris d’informació suggereixen que alguns models presenten limitacions ja sigui per una capacitat explicativa moderada o per la necessitat d’introduir components aleatoris per capturar dependències no observades, els patrons estimats són consistents amb els resultats obtinguts mitjançant altres mètodes, com l’anàlisi descriptiva i la comparació directa de percentatges de vot per grups sociodemogràfics.

Així, els models no només es poden interpretar com a eines predictives, sinó sobretot com a instruments analítics per sintetitzar i validar relacions estructurals entre el context sociodemogràfic i el comportament electoral. En aquest sentit, tot i les imperfeccions en termes de residus i autocorrelació, els resultats reforcen qualitativament les conclusions extretes per vies alternatives d’anàlisi.

```{r}
################################################################################
# ----- VISUALITZACIÓ TAULES PEL MODEL ESCOLLIT -----
################################################################################

library(gtsummary)
library(dplyr)
library(knitr)
library(kableExtra)

for (partit in partits) {
  
  model_sel <- models_mixtes[[partit]]$model1
  
  tbl <- tbl_regression(
    model_sel,
    exponentiate = TRUE,
    intercept = FALSE
  ) %>%
    modify_header(label ~ "Variable") %>%
    modify_caption(paste("Coeficients (OR) per al partit:", partit))
  
  # Extraiem el cos de la taula de gtsummary
  df_tbl <- tbl$table_body %>%
    select(label, estimate, ci, p.value) %>%
    rename(
      Variable = label,
      `OR` = estimate,
      `IC 95%` = ci,
      `p-valor` = p.value)%>%
    mutate(across(c(OR), ~ round(as.numeric(.), 2)))%>%
    mutate(across(c(`p-valor`), ~ round(as.numeric(.), 4)))%>%
    mutate(across(everything(), ~ ifelse(is.na(.), "", .)))
  
  # Pintem amb kable (LaTeX-friendly)
  print(kable(
    df_tbl,
    format = "markdown",
    booktabs = TRUE,
    caption = paste("Coeficients (OR) per al partit:", partit),
    digits = 3,
    align = "lccc"
  ) %>%
    kable_styling(
      latex_options = c("hold_position", "striped")
    ))
}
```


## 6.3 Validació del RF

Els valors de $R^2$ van variar entre 0,016 i 0,761, mostrant que la capacitat predictiva depenia força de com estava repartit el vot territorial del partit. La majoria de partits tenien un $R^2$ per sobre de 0,5. Per exemple, es veu que el PSC/PSOE sempre superava 0,73 en totes les eleccions, cosa que indica que el model captava bé els factors socioeconòmics que influïen en el seu suport. En canvi, VOX, sobretot a les eleccions de 2015 i 2016, tenia valors molt baixos ($R^2 < 0,03$), probablement per la poca mostra i per concentrar-se en zones molt concretes.

L’RMSE va ser més alt en partits amb vot dispers, com CONV./JxCAT a les eleccions d’abril de 2019, amb un RMSE de 0,0896. En canvi, partits amb vot més homogeni, com el PP o CS, tenien errors més petits, per exemple 0,0192 per PP i 0,0326 per CS. L’MAE seguia patrons molt semblants.

Quant a l’hiperparàmetre mtry, es va veure que els valors òptims estaven entre 2 i 5. Els partits amb moltes observacions funcionaven millor amb mtry més alt, mentre que els que tenien mostres petites milloraven amb valors més baixos, aconseguint un bon equilibri entre variància i biaix.

## 6.4 Validació del XGBoost

La validació del model XGBoost es va dur a terme sobre el conjunt de test per a cada elecció i partit, registrant-se el nombre d’observacions en entrenament i test, els valors òptims dels hiperparàmetres nrounds, max_depth i eta, així com les mesures de rendiment RMSE, MAE i $R^2$.

Els resultats van mostrar que, de manera general, XGBoost va obtenir un rendiment comparable al Random Forest, amb valors de $R^2$ elevats per a partits amb presència territorial estable i vot coherent. El PSC/PSOE va presentar els millors ajustos, amb $R^2$ superiors a 0.72 en totes les convocatòries, indicant una capacitat notable del model per capturar els factors socioeconòmics explicatius del suport a aquest partit. En canvi, VOX, especialment en les eleccions de 2015 i 2016, va registrar $R^2$ molt baixos (<0.005), probablement a causa de la reduïda mida de mostra i de la seva implantació territorial limitada.

L’error quadràtic mitjà (RMSE) i l’error absolut mitjà (MAE) van evidenciar patrons similars als observats amb Random Forest. Partits amb vot més dispers, com CONV./JxCAT a les eleccions de 2019, van presentar RMSE superiors a 0.09, mentre que partits amb vot més homogeni, com CS o PP, van mostrar errors menors, amb RMSE al voltant de 0.02–0.04. Aquesta distribució reflecteix la dificultat relativa del model per predir partits amb un vot territorialment heterogeni.

Els hiperparàmetres seleccionats van mantenir-se constants per a la majoria de models: nrounds = 150 i eta = 0.1. La profunditat màxima dels arbres (max_depth) va variar entre 4 i 6, depenent del partit i de la complexitat esperada de les interaccions entre predictors. Partits amb un volum gran d’observacions i patrons més complexos van requerir arbres més profunds, mentre que partits amb mostres més petites o amb vot concentrat van obtenir un millor rendiment amb arbres menys profunds, optimitzant l’equilibri entre complexitat i sobreajustament.

En síntesi, la validació del model XGBoos


\newpage

# 7. Conclusions

Aquest treball ha analitzat el comportament electoral a Catalunya durant el període 2015–2023 mitjançant una aproximació estadística i de machine learning basada en dades socioeconòmiques agregades a nivell de secció censal. L’objectiu principal ha estat identificar fins a quin punt les característiques socioeconòmiques del territori expliquen les diferències en el suport electoral als diferents partits, així com detectar patrons espacials i perfils electorals diferenciats.
Per assolir aquest objectiu, s’ha optat per una estratègia metodològica mixta que combina tècniques exploratòries (Anàlisi de Correspondències), models estadístics interpretables (model logit aplicat a la proporció de vot per secció censal) i mètodes avançats de machine learning (Random Forest i XGBoost). Aquesta combinació permet equilibrar capacitat predictiva, interpretabilitat i robustesa dels resultats.

## 7.1 Perfils socioeconòmics dels electorats

Els resultats mostren de manera clara que el vot a Catalunya està fortament estructurat per variables socioeconòmiques objectives. L’Anàlisi de Correspondències permet identificar una estratificació social nítida entre els electorats dels diferents partits, configurant perfils diferenciats i consistents al llarg del temps. En aquest sentit, partits com JxCat es vinculen majoritàriament a seccions censals amb nivells de renda molt elevats i població més embellida. I el bloc CUP–ERC es vinculen majoritàriament a seccions censals amb nivells de renda elevats i menor desigualtat, mentre que el PSC esta molt relacionat amb SUMAR ambdos presenten un suport més intens en zones amb perfils socioeconòmics més baixos,joves i llars unipersolas. El PP ocupa una posició més afí a seccions amb indexs de Gini elevats, el que indica zones desiguals.

Aquesta estratificació no és només descriptiva, sinó que es confirma quantitativament mitjançant els models estimats. Tant els models Random Forest com XGBoost identifiquen la renda, la desigualtat (índex de Gini) i la font principal d’ingressos com les variables amb major poder explicatiu. La coincidència entre ambdós algoritmes reforça la robustesa d’aquest resultat i suggereix que les relacions detectades no depenen d’un mètode concret, sinó que reflecteixen patrons estructurals del comportament electoral.

## 7.2 Importància de les variables socioeconòmiques

La renda emergeix de forma sistemàtica com la variable més rellevant en tots els models considerats. Tant en els models de machine learning com en els models mixtos logístics, increments en la renda mitjana de la secció censal s’associen amb canvis significatius en la probabilitat de vot a determinats partits. Les odds ratios estimades mitjançant LMER permeten quantificar aquests efectes i mostren diferències clares en la sensibilitat dels partits a aquesta variable.
La desigualtat interna de la secció censal, mesurada mitjançant l’índex de Gini, també juga un paper rellevant, especialment per a partits associats a perfils socioeconòmics alts o ideològicament polaritzats. Aquest resultat indica que no només el nivell mitjà de renda és important, sinó també la seva distribució, aportant una visió més rica del context social en què es produeix el vot.
Altres variables, com el percentatge de població no espanyola, resulten especialment rellevants per explicar el suport a partits com VOX o Ciutadans, mentre que tenen un impacte molt menor en formacions catalanistes. Aquest fet suggereix que determinades variables demogràfiques operen de manera diferencial segons el posicionament ideològic del partit.

## 7.3 Patrons espacials i estructura territorial

L’anàlisi espacial posa de manifest una clara divisió territorial a Catalunya, amb un eix est–oest que separa zones més benestants del litoral i l’àrea metropolitana de Barcelona de regions interiors amb perfils socioeconòmics més baixos. Aquest patró territorial es reflecteix de manera coherent en els resultats electorals i reforça la idea que el vot no pot entendre’s sense tenir en compte la dimensió espacial.
La incorporació d’efectes aleatoris en els models LMER permet capturar part d’aquesta heterogeneïtat territorial, millorant l’ajust del model i evitant atribuir a les variables socioeconòmiques efectes que en realitat corresponen a diferències estructurals entre territoris. Això és especialment rellevant en un context com el català, on les dinàmiques polítiques i socials presenten una forta component territorial.

## 7.4 Aportació metodològica

Un dels principals valors afegits d’aquest treball és la combinació de metodologies diverses aplicades a una mateixa problemàtica. Els models de machine learning ofereixen una elevada capacitat explicativa superant el 88% de variància explicada en alguns casos, mentre que els models estadístics permeten una interpretació directa dels efectes mitjançant odds ratios. L’ús conjunt d’aquestes eines proporciona una visió més completa del fenomen analitzat que la que s’obtindria amb una sola aproximació.
A més, l’ús de dades a nivell de secció censal permet una anàlisi espacial fina, minimitzant en part els problemes d’agregació presents en estudis basats en unitats territorials més grans. Tot i això, cal reconèixer que l’anàlisi continua sent agregada i que no permet inferir comportaments individuals de manera directa.

## 7.5 Limitacions i línies futures

Malgrat la robustesa dels resultats, aquest estudi presenta algunes limitacions. En primer lloc, l’ús de dades agregades pot donar lloc a biaixos ecològics. En segon lloc, no s’han incorporat variables més qualitatives, com el context polític específic de cada elecció, les campanyes electorals o el lideratge dels partits, que podrien explicar part de la variabilitat residual.
Com a línies futures, seria especialment interessant complementar aquesta anàlisi amb dades individuals procedents d’enquestes, així com explorar models dinàmics que capturin canvis temporals més fins. També es podria aprofundir en l’ús dels models desenvolupats amb finalitats predictives o de simulació d’escenaris electorals.

## 7.6 Conclusió final

En conjunt, aquest treball demostra que el comportament electoral a Catalunya està profundament condicionat per l’estructura socioeconòmica del territori. Les diferències en renda, desigualtat i composició demogràfica generen perfils electorals clarament diferenciats, que es manifesten de manera consistent al llarg del temps i de l’espai. La combinació de models estadístics i tècniques de machine learning ha permès identificar aquests patrons amb un alt grau de detall i fiabilitat, aportant una contribució rellevant a l’anàlisi quantitativa del comportament electoral.

\newpage

# Referències

::: {#refs}
:::

\newpage


# Annexos

## A. Descripció de variables

La nostra base de dades final conté les seguents 43 variables:

\begin{enumerate}
\item \textbf{any:} Any en què se celebra l’elecció general (2015, 2016, 2019 o 2023).

\item \textbf{mes:} Mes en què se celebra l’elecció general.

\item \textbf{provincia:} Codi de la província corresponent a la secció censal.

\item \textbf{districte:} Codi del districte electoral.

\item \textbf{seccio:} Codi identificador de la secció censal.

\item \textbf{nom\_partit:} Nom complet del partit polític o candidatura.

\item \textbf{vots:} Nombre total de vots obtinguts pel partit polític a la secció censal.

\item \textbf{Municipi:} Nom del municipi al qual pertany la secció censal.

\item \textbf{Codi\_municipi:} Codi oficial del municipi.

\item \textbf{Edad media de la población:} Edat mitjana de la població resident a la secció censal.

\item \textbf{Población:} Nombre total d’habitants de la secció censal.

\item \textbf{Porcentaje de hogares unipersonales:} Percentatge de llars formades per una sola persona.

\item \textbf{Porcentaje de población de 65 y más años:} Percentatge de població amb 65 anys o més.

\item \textbf{Porcentaje de población española:} Percentatge de població amb nacionalitat espanyola.

\item \textbf{Porcentaje de población menor de 18 años:} Percentatge de població menor de 18 anys.

\item \textbf{Tamaño medio del hogar:} Nombre mitjà de persones per llar a la secció censal.

\item \textbf{Distribución de la renta P80/P20:} Ràtio entre el percentil 80 i el percentil 20 de la distribució de la renda, com a mesura de desigualtat.

\item \textbf{Índice de Gini:} Índex de Gini de la renda a la secció censal.

\item \textbf{Fuente de ingreso: otras prestaciones:} Percentatge de llars amb ingressos provinents d’altres prestacions socials.

\item \textbf{Fuente de ingreso: otros ingresos:} Percentatge de llars amb ingressos procedents d’altres fonts no especificades.

\item \textbf{Fuente de ingreso: pensiones:} Percentatge de llars amb ingressos provinents de pensions.

\item \textbf{Fuente de ingreso: prestaciones por desempleo:} Percentatge de llars amb ingressos provinents de prestacions per atur.

\item \textbf{Fuente de ingreso: salario:} Percentatge de llars amb ingressos principals procedents del salari.

\item \textbf{Media de la renta por unidad de consumo:} Renda mitjana de les llars ajustada per la mida i composició mitjançant unitats de consum.

\item \textbf{Mediana de la renta por unidad de consumo:} Mediana de la renda de les llars ajustada per unitats de consum.

\item \textbf{Renta bruta media por hogar:} Renda bruta mitjana per llar.

\item \textbf{Renta bruta media por persona:} Renda bruta mitjana per persona.

\item \textbf{Renta neta media por hogar:} Renda neta mitjana per llar.

\item \textbf{Renta neta media por persona:} Renda neta mitjana per persona.

\item \textbf{sigles:} Sigles del partit polític, unificades mitjançant un diccionari per garantir la coherència temporal i agrupar coalicions equivalents.

\item \textbf{eleccio:} Variable creada que identifica de manera única cada elecció general mitjançant la combinació d’any i mes (per exemple, \textit{2019\_abr} i \textit{2019\_nov}).

\item \textbf{ideologia:} Variable categòrica que classifica els partits polítics en dos grans blocs ideològics: esquerra i dreta.

\item \textbf{independentista:} Variable dicotòmica que indica si el partit polític té una posició explícitament independentista respecte a Catalunya (Sí/No).

\item \textbf{fac\_Edad\_media:} Versió categòrica de l’edat mitjana de la població, amb tres nivells: secció jove, secció d’edat mitjana i secció envellida.

\item \textbf{fac\_Población:} Variable categòrica de la població de la secció censal, definida a partir de quartils.

\item \textbf{fac\_Tamaño\_medio\_del\_hogar:} Variable categòrica de la mida mitjana de la llar, definida a partir de tercils.

\item \textbf{fac\_renda\_bruta\_persona:} Renda bruta mitjana per persona categòrica, definida a partir de quintils.

\item \textbf{fac\_renda\_bruta\_llar:} Renda bruta mitjana per llar categòrica, definida a partir de quintils.

\item \textbf{fac\_renda\_media\_uc:} Renda mitjana per unitat de consum categòrica, definida a partir de quintils.

\item \textbf{fac\_renda\_mediana\_uc:} Mediana de la renda per unitat de consum categòrica, definida a partir de quintils.

\item \textbf{fac\_indice\_gini:} Versió categòrica de la distribució de l'índex de Gini, definida a partir de literatura prèvia i interpretada com a nivell de desigualtat (baixa, mitjana o alta).

\item \textbf{Porcentaje\_poblacion\_no\_española:} Percentatge de població no espanyola resident a la secció censal.

\item \textbf{fac\_poblacio\_no\_espanyola:} Variable categòrica del percentatge de població no espanyola, definida a partir de tercils (baixa, mitjana o alta immigració).
\end{enumerate}

\newpage

## B. Resultats CA {#sec:grafics_compl_ca}

Els següents gràfics mostren la qualitat de representació dels partits i de les variables socioeconòmiques i demogràfiques dins del pla factorial per cada elecció, així com la contribuació de cada perfil fila i columna a les dimensions principals. L'explicació completa es troba a l'apartat \nameref{sec:resultats_ca}. 

```{r, fig.cap="Qualitat de representació dels partits i les variables a les eleccions del desembre del 2015.", fig.width=12, fig.height=4.5, fig.pos='H'}
p1 <- plots_ca$`Desembre 2015`$rows_cos2
p2 <- plots_ca$`Desembre 2015`$cols_cos2

p1+p2
```

```{r, fig.cap="Contribució dels partits i les variables a les dimensions principals per les eleccions del desembre del 2015.", fig.width=12, fig.height=5, fig.pos='H'}
p1 <- plots_ca$`Desembre 2015`$rows_contrib
p2 <- plots_ca$`Desembre 2015`$cols_contrib

p1+p2
```

```{r, fig.cap="Qualitat de representació dels partits i les variables a les eleccions del juny del 2016.", fig.width=12, fig.height=4.5, fig.pos='H'}
p1 <- plots_ca$`Juny 2016`$rows_cos2
p2 <- plots_ca$`Juny 2016`$cols_cos2

p1+p2
```

```{r, fig.cap="Contribució dels partits i les variables a les dimensions principals per les eleccions del juny del 2016.", fig.width=12, fig.height=5, fig.pos='H'}
p1 <- plots_ca$`Juny 2016`$rows_contrib
p2 <- plots_ca$`Juny 2016`$cols_contrib

p1+p2
```

```{r, fig.cap="Qualitat de representació dels partits i les variables a les eleccions de l'abril del 2019.", fig.width=12, fig.height=4.5, fig.pos='H'}
p1 <- plots_ca$`Abril 2019`$rows_cos2
p2 <- plots_ca$`Abril 2019`$cols_cos2

p1+p2
```

```{r, fig.cap="Contribució dels partits i les variables a les dimensions principals per les eleccions de l'abril del 2019.", fig.width=12, fig.height=5, fig.pos='H'}
p1 <- plots_ca$`Abril 2019`$rows_contrib
p2 <- plots_ca$`Abril 2019`$cols_contrib

p1+p2
```

```{r, fig.cap="Qualitat de representació dels partits i les variables a les eleccions del novembre del 2019.", fig.width=12, fig.height=4.5, fig.pos='H'}
p1 <- plots_ca$`Novembre 2019`$rows_cos2
p2 <- plots_ca$`Novembre 2019`$cols_cos2

p1+p2
```

```{r, fig.cap="Contribució dels partits i les variables a les dimensions principals per les eleccions del novembre del 2019.", fig.width=12, fig.height=5, fig.pos='H'}
p1 <- plots_ca$`Novembre 2019`$rows_contrib
p2 <- plots_ca$`Novembre 2019`$cols_contrib

p1+p2
```

```{r, fig.cap="Qualitat de representació dels partits i les variables a les eleccions del juliol del 2023.", fig.width=12, fig.height=4.5, fig.pos='H'}
p1 <- plots_ca$`Juliol 2023`$rows_cos2
p2 <- plots_ca$`Juliol 2023`$cols_cos2

p1+p2
```

```{r, fig.cap="Contribució dels partits i les variables a les dimensions principals per les eleccions del juliol del 2023", fig.width=12, fig.height=5, fig.pos='H'}
p1 <- plots_ca$`Juliol 2023`$rows_contrib
p2 <- plots_ca$`Juliol 2023`$cols_contrib

p1+p2
```

\newpage

## D. Codi

Per visualitzar i explorar de manera interactiva els resultats del projecte, i poder interactuar amb les dades i les anàlisis de manera senzilla i intuïtiva, vam desenvolupar una aplicació Shiny. L'aplicació completa es pot consultar a: [Aplicació Shiny del projecte.](https://jordianguera.shinyapps.io/ComportamentElectoral/)

## C. Codi

Per assegurar la traçabilitat i la reproduïbilitat de totes les anàlisis, vam desenvolupar el projecte íntegrament a GitHub. El repositori complet es pot consultar a: [Repositori Github del projecte.](https://github.com/aniolvv2288/Treball-final-Consultoria-Estadistic)

